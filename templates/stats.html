{% extends "base.html" %}

{% block title %}ç»Ÿè®¡åˆ†æ - {{ config.APP_NAME }}{% endblock %}

{% block header %}ç»Ÿè®¡åˆ†æ{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="ms-2">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
            <a href="{{ url_for('index') }}" class="text-decoration-none">
                <i class="bi bi-house me-1"></i>é¦–é¡µ
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-graph-up me-1"></i>ç»Ÿè®¡åˆ†æ
        </li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<style>
    /* è¦†ç›–content-wrapperçš„é™åˆ¶ - ç»Ÿè®¡åˆ†æé¡µé¢å…¨å®½ */
    #page-content-wrapper {
        max-width: 100% !important;
        width: calc(100vw - 260px) !important;
        margin-left: 260px !important;
        padding: 0 !important;
    }

    .stats-container {
        margin: -1rem;
    }

    .stats-header {
        background: white;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .stats-header h2 {
        margin: 0;
        font-size: 1.1rem;
        color: #2E8B57;
    }

    .stats-header p {
        margin: 0.25rem 0 0;
        font-size: 0.8rem;
        color: #6c757d;
    }

    .stats-actions {
        display: flex;
        gap: 0.5rem;
    }

    .stats-actions .btn {
        font-size: 0.8rem;
        padding: 0.3rem 0.75rem;
    }

    /* æ¦‚è§ˆå¡ç‰‡ */
    .overview-row {
        display: flex;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .overview-card {
        flex: 1;
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .overview-card .label {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .overview-card .value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #212529;
    }

    .overview-card.primary { border-left: 4px solid #2E8B57; }
    .overview-card.warning { border-left: 4px solid #ffc107; }
    .overview-card.info { border-left: 4px solid #17a2b8; }
    .overview-card.success { border-left: 4px solid #28a745; }
    .overview-card.danger { border-left: 4px solid #dc3545; }

    /* å›¾è¡¨åŒºåŸŸ */
    .charts-section {
        padding: 0.75rem 1rem;
    }

    .charts-row {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .chart-card {
        flex: 1;
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .chart-card h6 {
        margin: 0 0 0.5rem;
        font-size: 0.85rem;
        color: #2E8B57;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chart-card .chart-dropdown {
        font-size: 0.7rem;
    }

    .chart-card canvas {
        max-height: 220px;
    }

    .chart-card.wide {
        flex: 2;
    }

    .chart-card.narrow {
        flex: 1;
    }

    /* è¡¨æ ¼åŒºåŸŸ */
    .tables-section {
        padding: 0 1rem 0.75rem;
    }

    .table-card {
        background: white;
        border-radius: 6px;
        margin-bottom: 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .table-card .card-header {
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid #dee2e6;
        font-size: 0.85rem;
        font-weight: bold;
        color: #2E8B57;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-card .card-header.danger {
        color: #dc3545;
    }

    .table-card .card-body {
        padding: 0.5rem 0.75rem;
    }

    .table {
        font-size: 0.8rem;
        margin: 0;
    }

    .table th {
        font-weight: 600;
        color: #495057;
        border-bottom-width: 2px;
    }

    .table td {
        padding: 0.4rem 0.5rem;
    }

    .progress-sm {
        height: 18px;
        font-size: 0.7rem;
    }

    .badge {
        font-size: 0.7rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="stats-header">
        <div>
            <h2><i class="bi bi-graph-up me-2"></i>æ•°æ®ç»Ÿè®¡åˆ†æ</h2>
            <p>å…¨é¢äº†è§£åœ°è´¨å…¬å›­å›¾æ–‘æ•°æ®åˆ†å¸ƒå’Œæ•´æ”¹æƒ…å†µ</p>
        </div>
        <div class="stats-actions">
            <button type="button" class="btn btn-outline-primary btn-sm" id="refreshData">
                <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
            </button>
            <button type="button" class="btn btn-primary btn-sm" id="exportReport">
                <i class="bi bi-file-earmark-pdf me-1"></i>å¯¼å‡ºæŠ¥å‘Š
            </button>
        </div>
    </div>

    <!-- æ¦‚è§ˆå¡ç‰‡ -->
    <div class="overview-row">
        <div class="overview-card primary">
            <div>
                <div class="label">å›¾æ–‘æ€»æ•°</div>
                <div class="value" id="total-count"><span class="loading"></span></div>
            </div>
            <div style="font-size: 1.5rem;">ğŸ“</div>
        </div>
        <div class="overview-card warning">
            <div>
                <div class="label">å¾…æ•´æ”¹</div>
                <div class="value" id="pending-count"><span class="loading"></span></div>
            </div>
            <div style="font-size: 1.5rem;">âš ï¸</div>
        </div>
        <div class="overview-card info">
            <div>
                <div class="label">æ•´æ”¹ä¸­</div>
                <div class="value" id="in-progress-count"><span class="loading"></span></div>
            </div>
            <div style="font-size: 1.5rem;">ğŸ”„</div>
        </div>
        <div class="overview-card success">
            <div>
                <div class="label">å·²é”€å·</div>
                <div class="value" id="closed-count"><span class="loading"></span></div>
            </div>
            <div style="font-size: 1.5rem;">âœ…</div>
        </div>
        <div class="overview-card danger">
            <div>
                <div class="label">è¶…æœŸ</div>
                <div class="value" id="overdue-count"><span class="loading"></span></div>
            </div>
            <div style="font-size: 1.5rem;">ğŸš¨</div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="charts-section">
        <div class="charts-row">
            <div class="chart-card">
                <h6>
                    é—®é¢˜ç±»å‹åˆ†å¸ƒ
                    <div class="dropdown d-inline-block">
                        <button class="btn btn-sm btn-outline-secondary chart-dropdown dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            å›¾è¡¨
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="changeChartType('problemType', 'pie')">é¥¼å›¾</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeChartType('problemType', 'bar')">æŸ±çŠ¶å›¾</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeChartType('problemType', 'doughnut')">ç¯å½¢å›¾</a></li>
                        </ul>
                    </div>
                </h6>
                <canvas id="problemTypeChart"></canvas>
            </div>
            <div class="chart-card">
                <h6>æ•´æ”¹è¿›å±•</h6>
                <canvas id="rectifyProgressChart"></canvas>
            </div>
        </div>
        <div class="charts-row">
            <div class="chart-card wide">
                <h6>æœˆåº¦è¶‹åŠ¿</h6>
                <canvas id="monthlyTrendChart"></canvas>
            </div>
            <div class="chart-card narrow">
                <h6>å½±å“ç¨‹åº¦</h6>
                <canvas id="impactChart"></canvas>
            </div>
        </div>
    </div>

    <!-- è¡¨æ ¼åŒºåŸŸ -->
    <div class="tables-section">
        <div class="table-card">
            <div class="card-header">
                <span>åœ°è´¨å…¬å›­ç»Ÿè®¡æ’å</span>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-hover" id="parkRankingTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 50px;">æ’å</th>
                                <th>åœ°è´¨å…¬å›­</th>
                                <th style="width: 80px;">æ€»æ•°</th>
                                <th style="width: 80px;">å¾…æ•´æ”¹</th>
                                <th style="width: 80px;">æ•´æ”¹ä¸­</th>
                                <th style="width: 80px;">å·²é”€å·</th>
                                <th style="width: 150px;">å®Œæˆç‡</th>
                            </tr>
                        </thead>
                        <tbody id="parkRankingBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <span class="loading"></span> åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="table-card">
            <div class="card-header danger">
                <span>âš ï¸ è¶…æœŸé¢„è­¦åˆ—è¡¨</span>
                <span class="badge bg-danger" id="overdue-count-badge">0</span>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                    <table class="table table-hover" id="overdueTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 100px;">å›¾æ–‘ç¼–å·</th>
                                <th>é¡¹ç›®åç§°</th>
                                <th style="width: 120px;">é—®é¢˜ç±»å‹</th>
                                <th style="width: 110px;">æ•´æ”¹æœŸé™</th>
                                <th style="width: 80px;">è¶…æœŸå¤©æ•°</th>
                                <th style="width: 70px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="overdueBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <span class="loading"></span> åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const chartColors = {
        primary: '#2E8B57',
        warning: '#ffc107',
        danger: '#dc3545',
        info: '#17a2b8',
        success: '#28a745',
        secondary: '#6c757d'
    };

    let charts = {};

    function loadOverview() {
        fetch('{{ url_for("stats.api_overview") }}')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-count').textContent = data.total_count;
                document.getElementById('pending-count').textContent = data.pending_count;
                document.getElementById('in-progress-count').textContent = data.in_progress_count;
                document.getElementById('closed-count').textContent = data.closed_count;
                document.getElementById('overdue-count').textContent = data.overdue_count;
                document.getElementById('overdue-count-badge').textContent = data.overdue_count;
            });
    }

    function loadProblemTypeChart(type = 'pie') {
        fetch('{{ url_for("stats.api_problem_types") }}')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('problemTypeChart').getContext('2d');
                if (charts.problemType) charts.problemType.destroy();

                charts.problemType = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: data.map(d => d.name),
                        datasets: [{
                            data: data.map(d => d.value),
                            backgroundColor: [chartColors.danger, chartColors.warning, chartColors.info, chartColors.success, chartColors.primary, chartColors.secondary]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 11 } } } }
                    }
                });
            });
    }

    function loadRectifyProgressChart() {
        fetch('{{ url_for("stats.api_rectify_progress") }}')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('rectifyProgressChart').getContext('2d');
                charts.rectifyProgress = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(d => d.name),
                        datasets: [{ data: data.map(d => d.value), backgroundColor: [chartColors.danger, chartColors.warning, chartColors.success] }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 11 } } } }
                    }
                });
            });
    }

    function loadMonthlyTrendChart() {
        fetch('{{ url_for("stats.api_monthly_trend") }}')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
                charts.monthlyTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.months,
                        datasets: [
                            { label: 'å‘ç°é—®é¢˜', data: data.discovered, borderColor: chartColors.danger, backgroundColor: chartColors.danger + '20', tension: 0.1 },
                            { label: 'å®Œæˆæ•´æ”¹', data: data.closed, borderColor: chartColors.success, backgroundColor: chartColors.success + '20', tension: 0.1 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { position: 'top' } }
                    }
                });
            });
    }

    function loadImpactChart() {
        fetch('{{ url_for("stats.api_impact_analysis") }}')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('impactChart').getContext('2d');
                charts.impact = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.impact_level),
                        datasets: [{ label: 'æ•°é‡', data: data.map(d => d.count), backgroundColor: [chartColors.danger, chartColors.warning, chartColors.info] }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            });
    }

    function loadParkRanking() {
        fetch('{{ url_for("stats.api_park_ranking") }}')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('parkRankingBody');
                tbody.innerHTML = '';
                data.sort((a, b) => b.total_count - a.total_count);

                data.forEach((park, index) => {
                    const rate = park.total_count > 0 ? Math.round((park.closed_count / park.total_count) * 100) : 0;
                    tbody.innerHTML += `<tr>
                        <td>${index + 1}</td>
                        <td>${park.park_name}</td>
                        <td>${park.total_count}</td>
                        <td><span class="badge bg-danger">${park.pending_count}</span></td>
                        <td><span class="badge bg-warning">${park.in_progress_count}</span></td>
                        <td><span class="badge bg-success">${park.closed_count}</span></td>
                        <td>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-success" style="width: ${rate}%">${rate}%</div>
                            </div>
                        </td>
                    </tr>`;
                });
            });
    }

    function loadOverdueList() {
        fetch('{{ url_for("stats.api_overdue_list") }}')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('overdueBody');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">æš‚æ— è¶…æœŸå›¾æ–‘</td></tr>';
                    return;
                }
                tbody.innerHTML = data.map(tuban => `<tr>
                    <td><a href="/tuban/detail/${tuban.id}" class="text-decoration-none">${tuban.tuban_code}</a></td>
                    <td>${tuban.park_name}</td>
                    <td>${tuban.problem_type}</td>
                    <td>${tuban.rectify_deadline}</td>
                    <td><span class="badge bg-danger">${tuban.overdue_days}å¤©</span></td>
                    <td><a href="/tuban/detail/${tuban.id}" class="btn btn-sm btn-outline-primary py-0">æŸ¥çœ‹</a></td>
                </tr>`).join('');
            });
    }

    function changeChartType(chartName, type) {
        if (chartName === 'problemType') loadProblemTypeChart(type);
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadOverview();
        loadProblemTypeChart();
        loadRectifyProgressChart();
        loadMonthlyTrendChart();
        loadImpactChart();
        loadParkRanking();
        loadOverdueList();
        setInterval(loadOverview, 30000);
    });
</script>
{% endblock %}
