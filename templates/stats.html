{% extends "base.html" %}

{% block title %}ç»Ÿè®¡åˆ†æ - {{ config.APP_NAME }}{% endblock %}

{% block header %}ç»Ÿè®¡åˆ†æ{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="ms-2">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
            <a href="{{ url_for('index') }}" class="text-decoration-none">
                <i class="bi bi-house me-1"></i>é¦–é¡µ
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-graph-up me-1"></i>ç»Ÿè®¡åˆ†æ
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<!-- é¡µé¢æ ‡é¢˜ -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="h5 mb-1 fw-bold text-primary">
                <i class="bi bi-graph-up me-2"></i>æ•°æ®ç»Ÿè®¡åˆ†æ
            </h2>
            <p class="text-muted mb-0 small">å…¨é¢äº†è§£åœ°è´¨å…¬å›­å›¾æ–‘æ•°æ®åˆ†å¸ƒå’Œæ•´æ”¹æƒ…å†µ</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm" id="refreshData">
                <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°æ•°æ®
            </button>
            <button type="button" class="btn btn-primary btn-sm" id="exportReport">
                <i class="bi bi-file-earmark-pdf me-1"></i>å¯¼å‡ºæŠ¥å‘Š
            </button>
        </div>
    </div>
</div>

<!-- å…³é”®æŒ‡æ ‡æ¦‚è§ˆ -->
<div class="stats-overview mb-3">
    <div class="row g-2" id="overview-cards">
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card primary h-100">
                <div class="card-body">
                    <div class="stats-content">
                        <div class="stats-label">å›¾æ–‘æ€»æ•°</div>
                        <div class="stats-value" id="total-count">
                            <span class="loading"></span>
                        </div>
                        <div class="stats-change text-muted">
                            <i class="bi bi-database me-1"></i>ç´¯è®¡æ•°æ®
                        </div>
                    </div>
                    <div class="stats-icon">ğŸ“</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card warning h-100">
                <div class="card-body">
                    <div class="stats-content">
                        <div class="stats-label">å¾…æ•´æ”¹</div>
                        <div class="stats-value" id="pending-count">
                            <span class="loading"></span>
                        </div>
                        <div class="stats-change text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>éœ€è¦å¤„ç†
                        </div>
                    </div>
                    <div class="stats-icon">âš ï¸</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card info h-100">
                <div class="card-body">
                    <div class="stats-content">
                        <div class="stats-label">æ•´æ”¹ä¸­</div>
                        <div class="stats-value" id="in-progress-count">
                            <span class="loading"></span>
                        </div>
                        <div class="stats-change text-info">
                            <i class="bi bi-arrow-repeat me-1"></i>è¿›è¡Œä¸­
                        </div>
                    </div>
                    <div class="stats-icon">ğŸ”„</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card success h-100">
                <div class="card-body">
                    <div class="stats-content">
                        <div class="stats-label">å·²é”€å·</div>
                        <div class="stats-value" id="closed-count">
                            <span class="loading"></span>
                        </div>
                        <div class="stats-change text-success">
                            <i class="bi bi-check-circle me-1"></i>å®Œæˆæ•°é‡
                        </div>
                    </div>
                    <div class="stats-icon">âœ…</div>
                </div>
            </div>
        </div>
    </div>
</div>
                            <span class="loading"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 mb-4">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">è¶…æœŸ</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="overdue-count">
                            <span class="loading"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å›¾è¡¨åŒºåŸŸ -->
<div class="row">
    <!-- é—®é¢˜ç±»å‹åˆ†å¸ƒ -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">é—®é¢˜ç±»å‹åˆ†å¸ƒ</h6>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        å›¾è¡¨ç±»å‹
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="changeChartType('problemType', 'pie')">é¥¼å›¾</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeChartType('problemType', 'bar')">æŸ±çŠ¶å›¾</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeChartType('problemType', 'doughnut')">ç¯å½¢å›¾</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <canvas id="problemTypeChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- æ•´æ”¹è¿›å±•ç»Ÿè®¡ -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">æ•´æ”¹è¿›å±•</h6>
            </div>
            <div class="card-body">
                <canvas id="rectifyProgressChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- æœˆåº¦è¶‹åŠ¿ -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">æœˆåº¦è¶‹åŠ¿</h6>
            </div>
            <div class="card-body">
                <canvas id="monthlyTrendChart" width="800" height="400"></canvas>
            </div>
        </div>
    </div>

    <!-- å½±å“ç¨‹åº¦åˆ†æ -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">å½±å“ç¨‹åº¦åˆ†æ</h6>
            </div>
            <div class="card-body">
                <canvas id="impactChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- åœ°è´¨å…¬å›­æ’å -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">åœ°è´¨å…¬å›­ç»Ÿè®¡æ’å</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="parkRankingTable">
                        <thead class="table-light">
                            <tr>
                                <th>æ’å</th>
                                <th>åœ°è´¨å…¬å›­</th>
                                <th>æ€»æ•°</th>
                                <th>å¾…æ•´æ”¹</th>
                                <th>æ•´æ”¹ä¸­</th>
                                <th>å·²é”€å·</th>
                                <th>å®Œæˆç‡</th>
                            </tr>
                        </thead>
                        <tbody id="parkRankingBody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <span class="loading"></span> åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è¶…æœŸé¢„è­¦åˆ—è¡¨ -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-danger">âš ï¸ è¶…æœŸé¢„è­¦åˆ—è¡¨</h6>
                <span class="badge bg-danger rounded-pill" id="overdue-count-badge">0</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="overdueTable">
                        <thead class="table-light">
                            <tr>
                                <th>å›¾æ–‘ç¼–å·</th>
                                <th>é¡¹ç›®åç§°</th>
                                <th>è®¾æ–½åç§°</th>
                                <th>é—®é¢˜ç±»å‹</th>
                                <th>æ•´æ”¹æœŸé™</th>
                                <th>è¶…æœŸå¤©æ•°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="overdueBody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <span class="loading"></span> åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // å›¾è¡¨é…ç½®
    const chartColors = {
        primary: '#2E8B57',
        warning: '#ffc107',
        danger: '#dc3545',
        info: '#17a2b8',
        success: '#28a745',
        secondary: '#6c757d'
    };

    let charts = {};

    // åŠ è½½æ¦‚è§ˆæ•°æ®
    function loadOverview() {
        fetch('{{ url_for("stats.api_overview") }}')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-count').textContent = data.total_count;
                document.getElementById('pending-count').textContent = data.pending_count;
                document.getElementById('in-progress-count').textContent = data.in_progress_count;
                document.getElementById('closed-count').textContent = data.closed_count;
                document.getElementById('overdue-count').textContent = data.overdue_count;
                document.getElementById('overdue-count-badge').textContent = data.overdue_count;
            });
    }

    // åŠ è½½é—®é¢˜ç±»å‹å›¾è¡¨
    function loadProblemTypeChart(type = 'pie') {
        fetch('{{ url_for("stats.api_problem_types") }}')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('problemTypeChart').getContext('2d');

                if (charts.problemType) {
                    charts.problemType.destroy();
                }

                charts.problemType = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: data.map(d => d.name),
                        datasets: [{
                            data: data.map(d => d.value),
                            backgroundColor: [
                                chartColors.danger,
                                chartColors.warning,
                                chartColors.info,
                                chartColors.success,
                                chartColors.primary,
                                chartColors.secondary
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20
                                }
                            }
                        }
                    }
                });
            });
    }

    // åŠ è½½æ•´æ”¹è¿›å±•å›¾è¡¨
    function loadRectifyProgressChart() {
        fetch('{{ url_for("stats.api_rectify_progress") }}')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('rectifyProgressChart').getContext('2d');

                charts.rectifyProgress = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(d => d.name),
                        datasets: [{
                            data: data.map(d => d.value),
                            backgroundColor: [
                                chartColors.danger,
                                chartColors.warning,
                                chartColors.success
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20
                                }
                            }
                        }
                    }
                });
            });
    }

    // åŠ è½½æœˆåº¦è¶‹åŠ¿å›¾è¡¨
    function loadMonthlyTrendChart() {
        fetch('{{ url_for("stats.api_monthly_trend") }}')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('monthlyTrendChart').getContext('2d');

                charts.monthlyTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.months,
                        datasets: [{
                            label: 'å‘ç°é—®é¢˜',
                            data: data.discovered,
                            borderColor: chartColors.danger,
                            backgroundColor: chartColors.danger + '20',
                            tension: 0.1
                        }, {
                            label: 'å®Œæˆæ•´æ”¹',
                            data: data.closed,
                            borderColor: chartColors.success,
                            backgroundColor: chartColors.success + '20',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
    }

    // åŠ è½½å½±å“ç¨‹åº¦å›¾è¡¨
    function loadImpactChart() {
        fetch('{{ url_for("stats.api_impact_analysis") }}')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('impactChart').getContext('2d');

                charts.impact = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.impact_level),
                        datasets: [{
                            label: 'æ•°é‡',
                            data: data.map(d => d.count),
                            backgroundColor: [
                                chartColors.danger,
                                chartColors.warning,
                                chartColors.info
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            });
    }

    // åŠ è½½åœ°è´¨å…¬å›­æ’å
    function loadParkRanking() {
        fetch('{{ url_for("stats.api_park_ranking") }}')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('parkRankingBody');
                tbody.innerHTML = '';

                data.sort((a, b) => b.total_count - a.total_count);

                data.forEach((park, index) => {
                    const completionRate = park.total_count > 0
                        ? Math.round((park.closed_count / park.total_count) * 100)
                        : 0;

                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${park.park_name}</td>
                            <td>${park.total_count}</td>
                            <td>
                                <span class="badge bg-danger">${park.pending_count}</span>
                            </td>
                            <td>
                                <span class="badge bg-warning">${park.in_progress_count}</span>
                            </td>
                            <td>
                                <span class="badge bg-success">${park.closed_count}</span>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" role="progressbar"
                                         style="width: ${completionRate}%">
                                        ${completionRate}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    // åŠ è½½è¶…æœŸé¢„è­¦åˆ—è¡¨
    function loadOverdueList() {
        fetch('{{ url_for("stats.api_overdue_list") }}')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('overdueBody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">æš‚æ— è¶…æœŸå›¾æ–‘</td></tr>';
                    return;
                }

                data.forEach(tuban => {
                    const row = `
                        <tr>
                            <td><a href="/tuban/detail/${tuban.id}" class="text-decoration-none">${tuban.tuban_code}</a></td>
                            <td>${tuban.park_name}</td>
                            <td>${tuban.facility_name}</td>
                            <td>${tuban.problem_type}</td>
                            <td>${tuban.rectify_deadline}</td>
                            <td><span class="badge bg-danger">${tuban.overdue_days}å¤©</span></td>
                            <td>
                                <a href="/tuban/detail/${tuban.id}" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹</a>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    // åˆ‡æ¢å›¾è¡¨ç±»å‹
    function changeChartType(chartName, type) {
        if (chartName === 'problemType') {
            loadProblemTypeChart(type);
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadOverview();
        loadProblemTypeChart();
        loadRectifyProgressChart();
        loadMonthlyTrendChart();
        loadImpactChart();
        loadParkRanking();
        loadOverdueList();

        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ¦‚è§ˆæ•°æ®
        setInterval(loadOverview, 30000);
    });
</script>
{% endblock %}"}