{% extends "base.html" %}

{% block title %}图斑详情 - {{ config.APP_NAME }}{% endblock %}

{% block header %}图斑详情{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="ms-2">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
            <a href="{{ url_for('index') }}" class="text-decoration-none">
                <i class="bi bi-house me-1"></i>首页
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('tuban.list') }}" class="text-decoration-none">
                <i class="bi bi-table me-1"></i>图斑管理
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-eye me-1"></i>{{ tuban.tuban_code }}
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- 1. 标题栏 -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('tuban.list') }}" class="btn btn-link text-secondary p-0 me-3 text-decoration-none">
                    <i class="bi bi-arrow-left fs-5"></i>
                </a>
                <div>
                    <div class="d-flex align-items-center gap-2">
                        <h4 class="mb-0 fw-bold text-dark font-monospace">{{ tuban.tuban_code }}</h4>
                        <span class="badge bg-{{ get_status_color(tuban.rectify_status) }} rounded-1">{{ tuban.rectify_status }}</span>
                        {% if tuban.is_superior_focus == '是' %}
                        <span class="badge bg-danger rounded-1"><i class="bi bi-star-fill"></i> 重点</span>
                        {% endif %}
                    </div>
                    <div class="d-flex align-items-center gap-2 mt-1 small text-muted">
                        <span class="fw-bold text-dark">{{ tuban.park_name }}</span>
                        <span class="border-start ps-2">{{ tuban.func_zone }}</span>
                        {% if tuban.is_punished == '是' %}
                        <span class="badge bg-danger ms-2">处罚中</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('tuban.edit', id=tuban.id) }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-pencil me-1"></i>编辑
                </a>
                <button type="button" class="btn btn-outline-danger btn-sm"
                    onclick="if(confirmDelete()) location.href='{{ url_for('tuban.delete', id=tuban.id) }}'">
                    <i class="bi bi-trash me-1"></i>删除
                </button>
            </div>
        </div>
    </div>

    <!-- 关联事件 -->
    {% set events_list = tuban.events.all() %}
    {% if events_list %}
    <div class="mb-3">
        <div class="d-flex align-items-center flex-wrap gap-2">
            <span class="fw-bold text-primary small"><i class="bi bi-calendar-event me-1"></i>关联事件：</span>
            {% for event in events_list %}
            <span class="badge bg-primary rounded-1">
                <i class="bi bi-tag me-1"></i>{{ event.event_name }}
                {% if event.issue_date %}
                <span class="opacity-75 ms-1">{{ event.issue_date.strftime('%Y-%m-%d') }}</span>
                {% endif %}
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- 2. 横向信息表格（充分利用宽度） -->
    <div class="row g-3">
        <!-- 基础信息 -->
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-info-circle me-2"></i>基础信息</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-bordered mb-0">
                        <tbody>
                            <tr>
                                <th style="width: 100px;" class="table-light">项目名称</th>
                                <td style="width: 25%;">{{ tuban.park_name }}</td>
                                <th style="width: 90px;" class="table-light">设施名称</th>
                                <td style="width: 25%;">{{ tuban.facility_name }}</td>
                                <th style="width: 90px;" class="table-light">功能分区</th>
                                <td>{{ tuban.func_zone }}</td>
                            </tr>
                            <tr>
                                <th class="table-light">占地面积</th>
                                <td>{{ tuban.area }} <span class="text-secondary small">m²</span></td>
                                <th class="table-light">建设时间</th>
                                <td>{{ format_date(tuban.build_time) }}</td>
                                <th class="table-light">影像时相</th>
                                <td>{{ format_date(tuban.image_date) }}</td>
                            </tr>
                            <tr>
                                <th class="table-light">地理坐标</th>
                                <td colspan="3">
                                    {% if tuban.longitude %}
                                    {{ "%.4f"|format(tuban.longitude) }}, {{ "%.4f"|format(tuban.latitude) }}
                                    <a href="/map?id={{ tuban.id }}" target="_blank" class="ms-1 text-decoration-none">
                                        <i class="bi bi-geo-alt-fill text-danger"></i>查看地图
                                    </a>
                                    {% else %}-{% endif %}
                                </td>
                                <th class="table-light">合规情况</th>
                                <td>
                                    <span class="{{ 'text-success' if tuban.has_approval == '是' else 'text-danger' }} fw-bold">
                                        <i class="bi {{ 'bi-check-circle' if tuban.has_approval == '是' else 'bi-x-circle' }} me-1"></i>{{ tuban.has_approval }}
                                    </span>
                                    {% if tuban.has_approval == '是' and tuban.approval_no %}
                                    <span class="text-muted small ms-2">文号: {{ tuban.approval_no }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th class="table-light">建设单位</th>
                                <td colspan="5">{{ tuban.build_unit or '-' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 发现核查 + 问题违法（2列布局） -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header py-2">
                    <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-search me-2"></i>发现与核查</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-bordered mb-0">
                        <tbody>
                            <tr>
                                <th style="width: 90px;" class="table-light">发现来源</th>
                                <td>{{ tuban.discover_method }}</td>
                                <th style="width: 80px;" class="table-light">发现时间</th>
                                <td>{{ format_date(tuban.discover_time) }}</td>
                            </tr>
                            <tr>
                                <th class="table-light">核查人员</th>
                                <td>{{ tuban.check_person }}</td>
                                <th class="table-light">核查时间</th>
                                <td>{{ format_date(tuban.check_time) }}</td>
                            </tr>
                            <tr>
                                <th class="table-light">核查结论</th>
                                <td colspan="3" class="fw-bold">{{ tuban.check_result or '-' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header py-2">
                    <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-exclamation-triangle me-2"></i>问题与违法</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-bordered mb-0">
                        <tbody>
                            <tr>
                                <th style="width: 80px;" class="table-light">问题类型</th>
                                <td>{{ tuban.problem_type }}</td>
                                <th style="width: 70px;" class="table-light">影响程度</th>
                                <td style="width: 90px;">
                                    {% set impact_colors = {'严重': 'danger', '较重': 'warning', '一般': 'info', '轻微': 'success'} %}
                                    {% set color = impact_colors.get(tuban.impact_level, 'secondary') %}
                                    <span class="badge bg-{{ color }}">{{ tuban.impact_level or '-' }}</span>
                                </td>
                            </tr>
                            <tr>
                                <th class="table-light">是否违法</th>
                                <td>
                                    <span class="{{ 'text-danger' if tuban.is_illegal == '是' else 'text-success' }} fw-bold">
                                        <i class="bi {{ 'bi-x-circle' if tuban.is_illegal == '是' else 'bi-check-circle' }} me-1"></i>{{ tuban.is_illegal or '-' }}
                                    </span>
                                </td>
                                <th class="table-light">上级关注</th>
                                <td>
                                    <span class="{{ 'text-danger' if tuban.is_superior_focus == '是' else 'text-muted' }}">
                                        <i class="bi {{ 'bi-star-fill' if tuban.is_superior_focus == '是' else 'bi-circle' }} me-1"></i>{{ tuban.is_superior_focus or '-' }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th class="table-light">违反条款</th>
                                <td colspan="3">{{ tuban.violated_law or '-' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 问题描述 -->
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-text-paragraph me-2"></i>问题描述</h6>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ tuban.problem_desc or '暂无描述' }}</p>
                    {% if tuban.geo_heritage_type %}
                    <div class="mt-2">
                        <span class="badge bg-info">涉及地质遗迹: {{ tuban.geo_heritage_type }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 整改信息 -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-arrow-repeat me-2"></i>整改信息</h6>
                    {% if tuban.rectify_deadline %}
                        {% set is_overdue = tuban.rectify_deadline < get_current_date() and tuban.rectify_status in ['未整改', '整改中'] %}
                        {% if is_overdue %}
                        <span class="badge bg-danger">已超期</span>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-bordered mb-0">
                        <tbody>
                            <tr>
                                <th style="width: 80px;" class="table-light">整改措施</th>
                                <td colspan="3">{{ tuban.rectify_measure or '-' }}</td>
                            </tr>
                            <tr>
                                <th style="width: 80px;" class="table-light">整改时限</th>
                                <td style="width: 20%;">
                                    {% if tuban.rectify_deadline %}
                                        <span class="{{ 'text-danger fw-bold' if is_overdue else '' }}">{{ format_date(tuban.rectify_deadline) }}</span>
                                    {% else %}-{% endif %}
                                </td>
                                <th style="width: 80px;" class="table-light">责任部门</th>
                                <td>{{ tuban.responsible_dept or '-' }}</td>
                            </tr>
                            <tr>
                                <th style="width: 80px;" class="table-light">验收时间</th>
                                <td>{{ format_date(tuban.rectify_verify_time) }}</td>
                                <th style="width: 80px;" class="table-light">验收人员</th>
                                <td>{{ tuban.verify_person or '-' }}</td>
                            </tr>
                            <tr>
                                <th style="width: 80px;" class="table-light">销号状态</th>
                                <td>
                                    <span class="{{ 'text-success' if tuban.is_closed == '是' else 'text-secondary' }} fw-bold">
                                        <i class="bi {{ 'bi-check-circle' if tuban.is_closed == '是' else 'bi-circle' }} me-1"></i>{{ tuban.is_closed or '否' }}
                                    </span>
                                </td>
                                <th colspan="2"></th>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 处罚信息 -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-gavel me-2"></i>处罚信息</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-bordered mb-0">
                        <tbody>
                            <tr>
                                <th style="width: 80px;" class="table-light">是否处罚</th>
                                <td>
                                    <span class="{{ 'text-danger' if tuban.is_punished == '是' else 'text-success' }} fw-bold">
                                        <i class="bi {{ 'bi-x-circle' if tuban.is_punished == '是' else 'bi-check-circle' }} me-1"></i>{{ tuban.is_punished or '-' }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th class="table-light">处罚形式</th>
                                <td>{{ tuban.punish_type or '-' }}</td>
                            </tr>
                            <tr>
                                <th class="table-light">罚款金额</th>
                                <td>{{ tuban.fine_amount or '-' }} <span class="text-secondary">万元</span></td>
                            </tr>
                            <tr>
                                <th class="table-light">处罚文书号</th>
                                <td>{{ tuban.punish_doc_no or '-' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 管理信息 -->
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-gear me-2"></i>管理信息</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-bordered mb-0">
                        <tbody>
                            <tr>
                                <th style="width: 120px;" class="table-light">台账来源</th>
                                <td style="width: 25%;">{{ tuban.data_source or '-' }}</td>
                                <th style="width: 120px;" class="table-light">是否为巡查点</th>
                                <td style="width: 25%;">
                                    <span class="{{ 'text-success' if tuban.is_patrol_point == '是' else 'text-secondary' }}">
                                        <i class="bi {{ 'bi-check-circle' if tuban.is_patrol_point == '是' else 'bi-circle' }} me-1"></i>{{ tuban.is_patrol_point or '否' }}
                                    </span>
                                </td>
                                <th style="width: 120px;" class="table-light">附件材料</th>
                                <td>
                                    {% if tuban.attachments %}
                                        {% set attachment_list = tuban.attachments.split(',') %}
                                        {% for att in attachment_list %}
                                            {% if att.strip() %}
                                            <a href="{{ url_for('tuban.download_attachment', filename=att.strip()) }}" class="btn btn-outline-primary btn-sm me-1 mb-1" target="_blank">
                                                <i class="bi bi-file-earmark me-1"></i>{{ att.strip() }}
                                            </a>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 底部：照片 + 整改记录 + 快捷操作（3列布局） -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-image me-2"></i>现场照片</h6>
                    <button class="btn btn-link btn-sm p-0 text-decoration-none" data-bs-toggle="modal" data-bs-target="#uploadPhotoModal">上传</button>
                </div>
                <div class="card-body p-2">
                    {% if photos %}
                        <div class="row g-2">
                            {% for photo in photos %}
                            <div class="col-4">
                                <img src="{{ url_for('tuban.images', filename=photo.filename) }}" class="img-thumbnail w-100" style="aspect-ratio: 1; object-fit: cover;" alt="现场照片">
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-3 text-muted small">
                            <i class="bi bi-camera" style="font-size: 1.5rem;"></i>
                            <p class="mb-0 mt-1">暂无照片</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-clock-history me-2"></i>整改记录</h6>
                </div>
                <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                    {% if rectify_records %}
                        <div class="timeline">
                            {% for record in rectify_records %}
                            <div class="timeline-item {{ 'warning' if record.status == '整改中' else ('danger' if record.status == '延期' else '') }}">
                                <div class="timeline-time">{{ format_date(record.record_time) }}</div>
                                <div class="timeline-content">
                                    <div class="fw-bold">{{ record.status }}</div>
                                    <div class="small text-muted">{{ record.content }}</div>
                                    {% if record.operator %}
                                    <div class="small mt-1"><i class="bi bi-person me-1"></i>{{ record.operator }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-3 text-muted small">暂无整改记录</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-lightning me-2"></i>快捷操作</h6>
                </div>
                <div class="card-body p-2">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#addRecordModal">
                            <i class="bi bi-plus-circle me-1"></i>添加整改记录
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#uploadPhotoModal">
                            <i class="bi bi-camera me-1"></i>上传现场照片
                        </button>
                        <a href="/map?id={{ tuban.id }}" target="_blank" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-geo-alt me-1"></i>查看地图位置
                        </a>
                    </div>
                </div>
            </div>
            {% if tuban.remark %}
            <div class="card mt-3">
                <div class="card-header py-2">
                    <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-chat-left-text me-2"></i>备注</h6>
                </div>
                <div class="card-body p-2">
                    <p class="mb-0 small">{{ tuban.remark }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 上传照片模态框 -->
<div class="modal fade" id="uploadPhotoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h6 class="modal-title"><i class="bi bi-camera me-2"></i>上传现场照片</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('tuban.upload_image', id=tuban.id, type='photo') }}" enctype="multipart/form-data">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="photo" class="form-label">选择照片</label>
                        <input type="file" class="form-control" id="photo" name="photo" accept="image/*" required>
                    </div>
                    <div class="mb-3">
                        <label for="photo_desc" class="form-label">照片描述</label>
                        <input type="text" class="form-control" id="photo_desc" name="description" placeholder="可选">
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary btn-sm">上传</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 添加整改记录模态框 -->
<div class="modal fade" id="addRecordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white py-2">
                <h6 class="modal-title"><i class="bi bi-plus-circle me-2"></i>添加整改记录</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('tuban.add_rectify_record', id=tuban.id) }}">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="record_status" class="form-label">整改状态</label>
                        <select class="form-select form-select-sm" id="record_status" name="status" required>
                            <option value="整改中">整改中</option>
                            <option value="已整改">已整改</option>
                            <option value="延期">延期</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="record_desc" class="form-label">整改说明</label>
                        <textarea class="form-control form-control-sm" id="record_desc" name="content" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="record_person" class="form-label">记录人</label>
                        <input type="text" class="form-control form-control-sm" id="record_person" name="operator" value="{{ session.username }}">
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-success btn-sm">添加记录</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
