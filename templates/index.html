{% extends "base.html" %}

{% block title %}é¦–é¡µæ¦‚è§ˆ - {{ config.APP_NAME }}{% endblock %}

{% block header %}é¦–é¡µæ¦‚è§ˆ{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="ms-2">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-house me-1"></i>é¦–é¡µ
        </li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<style>
    /* è¦†ç›–content-wrapperçš„é™åˆ¶ - é¦–é¡µå…¨å®½ */
    #page-content-wrapper {
        max-width: 100% !important;
        width: calc(100vw - 260px) !important;
        margin-left: 260px !important;
        padding: 0 !important;
    }

    .home-container {
        margin: -1rem;
    }

    .home-header {
        background: white;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .home-header h2 {
        margin: 0;
        font-size: 1.1rem;
        color: #2E8B57;
    }

    .home-header p {
        margin: 0.25rem 0 0;
        font-size: 0.8rem;
        color: #6c757d;
    }

    /* æ¦‚è§ˆå¡ç‰‡è¡Œ */
    .overview-row {
        display: flex;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .overview-card {
        flex: 1;
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .overview-card .info {
        flex: 1;
    }

    .overview-card .label {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .overview-card .value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #212529;
    }

    .overview-card .sub {
        font-size: 0.7rem;
        color: #6c757d;
    }

    .overview-card .icon {
        font-size: 1.5rem;
        margin-left: 0.5rem;
    }

    .overview-card.primary { border-left: 4px solid #2E8B57; }
    .overview-card.warning { border-left: 4px solid #ffc107; }
    .overview-card.info { border-left: 4px solid #17a2b8; }
    .overview-card.success { border-left: 4px solid #28a745; }

    /* å›¾è¡¨åŒºåŸŸ */
    .charts-section {
        padding: 0.75rem 1rem;
    }

    .charts-row {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .chart-card {
        flex: 1;
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .chart-card h6 {
        margin: 0 0 0.5rem;
        font-size: 0.85rem;
        color: #2E8B57;
    }

    .chart-card canvas {
        max-height: 200px;
    }

    /* é¢„è­¦åŒºåŸŸ */
    .alert-section {
        padding: 0 1rem 0.75rem;
    }

    .alert-row {
        display: flex;
        gap: 0.75rem;
    }

    .alert-card {
        flex: 1;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .alert-card .card-header {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .alert-card.danger .card-header {
        background: #dc3545;
        color: white;
    }

    .alert-card.warning .card-header {
        background: #ffc107;
        color: #212529;
    }

    .alert-card .card-body {
        padding: 0.75rem;
    }

    .alert-card .alert-message {
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
    }

    .alert-card.danger .alert-message {
        color: #dc3545;
    }

    .alert-card.warning .alert-message {
        color: #856404;
    }

    .alert-card .card-footer {
        padding: 0.5rem 0.75rem;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: #6c757d;
    }

    .alert-card .btn {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="home-container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="home-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="bi bi-speedometer2 me-2"></i>å…³é”®æŒ‡æ ‡æ¦‚è§ˆ</h2>
                <p class="mb-0"><i class="bi bi-clock me-1"></i>{{ get_current_date() }}</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('tuban.list') }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-table me-1"></i>å›¾æ–‘ç®¡ç†
                </a>
                <a href="{{ url_for('map.index') }}" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-map me-1"></i>åœ°å›¾å±•ç¤º
                </a>
            </div>
        </div>
    </div>

    <!-- æ¦‚è§ˆå¡ç‰‡ -->
    <div class="overview-row">
        <div class="overview-card primary">
            <div class="info">
                <div class="label">å›¾æ–‘æ€»æ•°</div>
                <div class="value">{{ "{:,}".format(total_count) }}</div>
                <div class="sub"><i class="bi bi-database me-1"></i>ç´¯è®¡æ•°æ®</div>
            </div>
            <div class="icon">ğŸ“</div>
        </div>

        <div class="overview-card warning">
            <div class="info">
                <div class="label">å¾…æ•´æ”¹</div>
                <div class="value">{{ "{:,}".format(pending_count) }}</div>
                <div class="sub"><i class="bi bi-exclamation-triangle me-1"></i>éœ€è¦å¤„ç†</div>
            </div>
            <div class="icon">âš ï¸</div>
        </div>

        <div class="overview-card info">
            <div class="info">
                <div class="label">æ•´æ”¹ä¸­</div>
                <div class="value">{{ "{:,}".format(in_progress_count) }}</div>
                <div class="sub"><i class="bi bi-arrow-repeat me-1"></i>è¿›è¡Œä¸­</div>
            </div>
            <div class="icon">ğŸ”„</div>
        </div>

        <div class="overview-card success">
            <div class="info">
                <div class="label">å·²é”€å·</div>
                <div class="value">{{ "{:,}".format(closed_count) }}</div>
                <div class="sub">
                    <i class="bi bi-check-circle me-1"></i>
                    å®Œæˆç‡ {{ "%.1f"|format((closed_count / total_count * 100) if total_count > 0 else 0) }}%
                </div>
            </div>
            <div class="icon">âœ…</div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="charts-section">
        <div class="charts-row">
            <div class="chart-card">
                <h6><i class="bi bi-pie-chart me-2"></i>é—®é¢˜ç±»å‹åˆ†å¸ƒ</h6>
                <canvas id="problemTypeChart"></canvas>
            </div>
            <div class="chart-card">
                <h6><i class="bi bi-bar-chart me-2"></i>åŠŸèƒ½åŒºåˆ†å¸ƒ</h6>
                <canvas id="zoneChart"></canvas>
            </div>
        </div>
    </div>

    <!-- é¢„è­¦åŒºåŸŸ -->
    <div class="alert-section">
        <div class="alert-row">
            <!-- è¶…æœŸé¢„è­¦ -->
            <div class="alert-card danger">
                <div class="card-header">
                    <span><i class="bi bi-exclamation-triangle me-2"></i>è¶…æœŸé¢„è­¦</span>
                    <span class="badge bg-white text-danger rounded-pill">{{ overdue_count }}</span>
                </div>
                <div class="card-body">
                    {% if overdue_count > 0 %}
                    <div class="alert-message">
                        <i class="bi bi-alarm me-1"></i>
                        <strong>{{ overdue_count }}</strong> ä¸ªå›¾æ–‘æ•´æ”¹å·²è¶…æœŸï¼Œè¯·ç«‹å³å¤„ç†ï¼
                    </div>
                    {% else %}
                    <div class="alert-message text-center text-muted py-2">
                        <i class="bi bi-check-circle text-success me-1"></i>
                        æš‚æ— è¶…æœŸå›¾æ–‘
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <span>æœ€åæ›´æ–°: {{ get_current_date() }}</span>
                    <a href="{{ url_for('tuban.list', rectify_status='æœªæ•´æ”¹') }}" class="btn btn-danger btn-sm">
                        ç«‹å³æŸ¥çœ‹ <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>

            <!-- æœ¬å‘¨å¾…åŠ -->
            <div class="alert-card warning">
                <div class="card-header">
                    <span><i class="bi bi-calendar-week me-2"></i>æœ¬å‘¨å¾…åŠ</span>
                    <span class="badge bg-dark text-warning rounded-pill">{{ week_todo }}</span>
                </div>
                <div class="card-body">
                    {% if week_todo > 0 %}
                    <div class="alert-message">
                        <i class="bi bi-calendar-check me-1"></i>
                        æœ¬å‘¨æœ‰ <strong>{{ week_todo }}</strong> ä¸ªå›¾æ–‘éœ€è¦å®Œæˆæ•´æ”¹
                    </div>
                    {% else %}
                    <div class="alert-message text-center text-muted py-2">
                        <i class="bi bi-cup-hot me-1"></i>
                        æœ¬å‘¨æš‚æ— å¾…åŠäº‹é¡¹
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <span>æœ¬å‘¨å†…å¤„ç†</span>
                    <a href="{{ url_for('tuban.list') }}" class="btn btn-warning btn-sm">
                        æŸ¥çœ‹å¾…åŠ <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // é—®é¢˜ç±»å‹åˆ†å¸ƒé¥¼å›¾
    const problemCtx = document.getElementById('problemTypeChart').getContext('2d');
    new Chart(problemCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for stat in problem_stats %}'{{ stat.problem_type }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for stat in problem_stats %}{{ stat.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#28a745', '#6c757d', '#0d6efd']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 12, font: { size: 11 } }
                }
            }
        }
    });

    // åŠŸèƒ½åŒºåˆ†å¸ƒæŸ±çŠ¶å›¾
    const zoneCtx = document.getElementById('zoneChart').getContext('2d');
    new Chart(zoneCtx, {
        type: 'bar',
        data: {
            labels: [{% for stat in zone_stats %}'{{ stat.func_zone }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'å›¾æ–‘æ•°é‡',
                data: [{% for stat in zone_stats %}{{ stat.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: '#2E8B57',
                borderColor: '#228B22',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } } },
                x: { ticks: { font: { size: 11 } } }
            },
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}
