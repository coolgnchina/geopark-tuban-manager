{% extends "base.html" %}

{% block title %}é¦–é¡µæ¦‚è§ˆ - {{ config.APP_NAME }}{% endblock %}

{% block header %}é¦–é¡µæ¦‚è§ˆ{% endblock %}

{% block content %}
<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">å›¾æ–‘æ€»æ•°</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_count }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-geo-alt-fill fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">å¾…æ•´æ”¹</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_count }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-exclamation-triangle-fill fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">æ•´æ”¹ä¸­</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ in_progress_count }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-arrow-repeat fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">å·²é”€å·</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ closed_count }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-check-circle-fill fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å›¾è¡¨åŒºåŸŸ -->
<div class="row">
    <!-- é—®é¢˜ç±»å‹åˆ†å¸ƒ -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">é—®é¢˜ç±»å‹åˆ†å¸ƒ</h6>
            </div>
            <div class="card-body">
                <canvas id="problemTypeChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½åŒºåˆ†å¸ƒ -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">åŠŸèƒ½åŒºåˆ†å¸ƒ</h6>
            </div>
            <div class="card-body">
                <canvas id="zoneChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- é¢„è­¦ä¿¡æ¯ -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-danger">âš ï¸ è¶…æœŸé¢„è­¦</h6>
                <span class="badge bg-danger rounded-pill">{{ overdue_count }}</span>
            </div>
            <div class="card-body">
                {% if overdue_count > 0 %}
                    <p class="text-danger">æœ‰ {{ overdue_count }} ä¸ªå›¾æ–‘æ•´æ”¹å·²è¶…æœŸï¼Œè¯·å°½å¿«å¤„ç†ï¼</p>
                    <a href="{{ url_for('tuban.list', rectify_status='æœªæ•´æ”¹') }}" class="btn btn-sm btn-danger">æŸ¥çœ‹è¯¦æƒ…</a>
                {% else %}
                    <p class="text-muted">æš‚æ— è¶…æœŸå›¾æ–‘</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-warning">ğŸ“… æœ¬å‘¨å¾…åŠ</h6>
                <span class="badge bg-warning rounded-pill">{{ week_todo }}</span>
            </div>
            <div class="card-body">
                {% if week_todo > 0 %}
                    <p class="text-warning">æœ¬å‘¨æœ‰ {{ week_todo }} ä¸ªå›¾æ–‘éœ€è¦å®Œæˆæ•´æ”¹ã€‚</p>
                    <a href="{{ url_for('tuban.list') }}" class="btn btn-sm btn-warning">æŸ¥çœ‹è¯¦æƒ…</a>
                {% else %}
                    <p class="text-muted">æœ¬å‘¨æš‚æ— å¾…åŠäº‹é¡¹</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // é—®é¢˜ç±»å‹åˆ†å¸ƒé¥¼å›¾
    const problemCtx = document.getElementById('problemTypeChart').getContext('2d');
    new Chart(problemCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for stat in problem_stats %}'{{ stat.problem_type }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for stat in problem_stats %}{{ stat.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20
                    }
                }
            }
        }
    });

    // åŠŸèƒ½åŒºåˆ†å¸ƒæŸ±çŠ¶å›¾
    const zoneCtx = document.getElementById('zoneChart').getContext('2d');
    new Chart(zoneCtx, {
        type: 'bar',
        data: {
            labels: [{% for stat in zone_stats %}'{{ stat.func_zone }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'å›¾æ–‘æ•°é‡',
                data: [{% for stat in zone_stats %}{{ stat.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: '#2E8B57',
                borderColor: '#228B22',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
</script>
{% endblock %}