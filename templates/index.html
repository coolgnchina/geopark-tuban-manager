{% extends "base.html" %}

{% block title %}é¦–é¡µæ¦‚è§ˆ - {{ config.APP_NAME }}{% endblock %}

{% block header %}é¦–é¡µæ¦‚è§ˆ{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="ms-3">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-house me-1"></i>é¦–é¡µ
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="content-wrapper">
<!-- å…³é”®æŒ‡æ ‡æ¦‚è§ˆ -->
<div class="dashboard-overview mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h4 mb-0 fw-bold text-primary">
            <i class="bi bi-speedometer2 me-2"></i>å…³é”®æŒ‡æ ‡æ¦‚è§ˆ
        </h2>
        <small class="text-muted">
            <i class="bi bi-clock me-1"></i>æœ€åæ›´æ–°: {{ get_current_date() }}
        </small>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ -->
    <div class="stats-row">
        <div class="col">
            <div class="card stats-card primary h-100">
                <div class="card-body">
                    <div class="stats-content">
                        <div class="stats-label">å›¾æ–‘æ€»æ•°</div>
                        <div class="stats-value">{{ "{:,}".format(total_count) }}</div>
                        <div class="stats-change text-muted">
                            <i class="bi bi-database me-1"></i>ç´¯è®¡æ•°æ®
                        </div>
                    </div>
                    <div class="stats-icon">ğŸ“</div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card stats-card warning h-100">
                <div class="card-body">
                    <div class="stats-content">
                        <div class="stats-label">å¾…æ•´æ”¹</div>
                        <div class="stats-value">{{ "{:,}".format(pending_count) }}</div>
                        <div class="stats-change text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>éœ€è¦å¤„ç†
                        </div>
                    </div>
                    <div class="stats-icon">âš ï¸</div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card stats-card info h-100">
                <div class="card-body">
                    <div class="stats-content">
                        <div class="stats-label">æ•´æ”¹ä¸­</div>
                        <div class="stats-value">{{ "{:,}".format(in_progress_count) }}</div>
                        <div class="stats-change text-info">
                            <i class="bi bi-arrow-repeat me-1"></i>è¿›è¡Œä¸­
                        </div>
                    </div>
                    <div class="stats-icon">ğŸ”„</div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card stats-card success h-100">
                <div class="card-body">
                    <div class="stats-content">
                        <div class="stats-label">å·²é”€å·</div>
                        <div class="stats-value">{{ "{:,}".format(closed_count) }}</div>
                        <div class="stats-change text-success">
                            <i class="bi bi-check-circle me-1"></i>å®Œæˆç‡ {{ "%.1f"|format((closed_count / total_count * 100) if total_count > 0 else 0) }}%
                        </div>
                    </div>
                    <div class="stats-icon">âœ…</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ•°æ®å¯è§†åŒ–åŒºåŸŸ -->
<div class="chart-section mb-4">
    <h2 class="h4 mb-3 fw-bold text-primary">
        <i class="bi bi-graph-up me-2"></i>æ•°æ®å¯è§†åŒ–
    </h2>

    <div class="chart-row">
        <!-- é—®é¢˜ç±»å‹åˆ†å¸ƒ -->
        <div class="col">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-pie-chart me-2 text-primary"></i>é—®é¢˜ç±»å‹åˆ†å¸ƒ
                    </h6>
                    <small class="text-muted">æŒ‰ç±»åˆ«ç»Ÿè®¡</small>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="problemTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½åŒºåˆ†å¸ƒ -->
        <div class="col">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-bar-chart me-2 text-primary"></i>åŠŸèƒ½åŒºåˆ†å¸ƒ
                    </h6>
                    <small class="text-muted">æŒ‰åŒºåŸŸç»Ÿè®¡</small>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="zoneChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é¢„è­¦å’Œå¾…åŠä¿¡æ¯ -->
<div class="alert-section">
    <h2 class="h4 mb-3 fw-bold text-primary">
        <i class="bi bi-bell me-2"></i>é‡è¦æé†’
    </h2>

    <div class="stats-row">
        <!-- è¶…æœŸé¢„è­¦ -->
        <div class="col">
            <div class="card border-danger h-100">
                <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-exclamation-triangle me-2"></i>è¶…æœŸé¢„è­¦
                    </h6>
                    <span class="badge bg-white text-danger rounded-pill">{{ overdue_count }}</span>
                </div>
                <div class="card-body">
                    {% if overdue_count > 0 %}
                        <div class="alert alert-danger border-0 bg-transparent">
                            <i class="bi bi-alarm me-2"></i>
                            <strong>{{ overdue_count }}</strong> ä¸ªå›¾æ–‘æ•´æ”¹å·²è¶…æœŸï¼Œè¯·ç«‹å³å¤„ç†ï¼
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">æœ€åæ£€æŸ¥: {{ get_current_date() }}</small>
                            <a href="{{ url_for('tuban.list', rectify_status='æœªæ•´æ”¹') }}" class="btn btn-danger btn-sm">
                                <i class="bi bi-arrow-right me-1"></i>ç«‹å³æŸ¥çœ‹
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                            <p class="text-success mb-0 mt-2">æš‚æ— è¶…æœŸå›¾æ–‘</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- æœ¬å‘¨å¾…åŠ -->
        <div class="col">
            <div class="card border-warning h-100">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-calendar-week me-2"></i>æœ¬å‘¨å¾…åŠ
                    </h6>
                    <span class="badge bg-dark text-warning rounded-pill">{{ week_todo }}</span>
                </div>
                <div class="card-body">
                    {% if week_todo > 0 %}
                        <div class="alert alert-warning border-0 bg-transparent">
                            <i class="bi bi-calendar-check me-2"></i>
                            æœ¬å‘¨æœ‰ <strong>{{ week_todo }}</strong> ä¸ªå›¾æ–‘éœ€è¦å®Œæˆæ•´æ”¹
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">æœ¬å‘¨å†…å¤„ç†</small>
                            <a href="{{ url_for('tuban.list') }}" class="btn btn-warning btn-sm">
                                <i class="bi bi-list-task me-1"></i>æŸ¥çœ‹å¾…åŠ
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="bi bi-cup-hot text-muted" style="font-size: 2rem;"></i>
                            <p class="text-muted mb-0 mt-2">æœ¬å‘¨æš‚æ— å¾…åŠäº‹é¡¹</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // é—®é¢˜ç±»å‹åˆ†å¸ƒé¥¼å›¾
    const problemCtx = document.getElementById('problemTypeChart').getContext('2d');
    new Chart(problemCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for stat in problem_stats %}'{{ stat.problem_type }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for stat in problem_stats %}{{ stat.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20
                    }
                }
            }
        }
    });

    // åŠŸèƒ½åŒºåˆ†å¸ƒæŸ±çŠ¶å›¾
    const zoneCtx = document.getElementById('zoneChart').getContext('2d');
    new Chart(zoneCtx, {
        type: 'bar',
        data: {
            labels: [{% for stat in zone_stats %}'{{ stat.func_zone }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'å›¾æ–‘æ•°é‡',
                data: [{% for stat in zone_stats %}{{ stat.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: '#2E8B57',
                borderColor: '#228B22',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
</script>
{% endblock %}