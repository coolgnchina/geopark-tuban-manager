{% extends "base.html" %}

{% block title %}地图展示 - {{ config.APP_NAME }}{% endblock %}

{% block header %}图斑地图展示{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="ms-2">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
            <a href="{{ url_for('index') }}" class="text-decoration-none">
                <i class="bi bi-house me-1"></i>首页
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-map me-1"></i>地图展示
        </li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<style>
    /* 地图页面容器 - 覆盖全局限制 */
    .map-page-container {
        height: calc(100vh - 120px);
        overflow: hidden;
        margin: -1rem 0 -1rem -1rem;
        width: calc(100% + 1rem);
        max-width: none !important;
    }

    /* 顶部工具栏 */
    .map-toolbar {
        background: var(--bs-white);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* 左侧筛选区 */
    .toolbar-filters {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex: 1;
    }

    .toolbar-filters select {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
        width: auto;
        min-width: 90px;
        max-width: 130px;
    }

    /* 右侧统计区 */
    .toolbar-stats {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .stat-mini {
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        color: white;
        font-size: 0.75rem;
        text-align: center;
        min-width: 50px;
    }

    .stat-mini .num { font-weight: bold; font-size: 0.85rem; }
    .stat-mini .label { opacity: 0.85; font-size: 0.65rem; }

    .stat-mini.total { background: #2E8B57; }
    .stat-mini.pending { background: #dc3545; }
    .stat-mini.progress { background: #FFA500; }
    .stat-mini.closed { background: #17a2b8; }

    /* 主内容区 */
    .map-body {
        height: calc(100% - 42px);
        display: flex;
        overflow: hidden;
    }

    /* 地图区域 */
    .map-section {
        flex: 1;
        position: relative;
        height: 100%;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    /* 图例 */
    .map-legend {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: white;
        padding: 0.4rem 0.6rem;
        border-radius: 4px;
        font-size: 0.7rem;
        z-index: 1000;
        display: flex;
        gap: 0.75rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .legend-item span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    /* 底图切换 */
    .basemap-switch {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        display: flex;
        background: white;
        border-radius: 4px;
        overflow: hidden;
    }

    .basemap-switch button {
        border: none;
        padding: 0.3rem 0.6rem;
        font-size: 0.7rem;
        background: transparent;
        cursor: pointer;
    }

    .basemap-switch button.active {
        background: #2E8B57;
        color: white;
    }

    /* 图斑列表 */
    .list-section {
        width: 320px;
        min-width: 280px;
        max-width: 400px;
        background: white;
        border-left: 1px solid var(--bs-border-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .list-header {
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--bs-border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .list-header h6 {
        margin: 0;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .list-count {
        background: #2E8B57;
        color: white;
        padding: 0.1rem 0.4rem;
        border-radius: 10px;
        font-size: 0.7rem;
    }

    /* 列表内容 */
    .list-content {
        flex: 1;
        overflow-y: auto;
    }

    .list-item {
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--bs-border-color);
        cursor: pointer;
        transition: background 0.15s;
    }

    .list-item:hover {
        background: var(--bs-light-bg-subtle);
    }

    .list-item.active {
        background: var(--bs-primary-bg-subtle);
        border-left: 3px solid var(--bs-primary);
    }

    .item-code {
        font-weight: bold;
        color: var(--bs-primary);
        font-size: 0.85rem;
    }

    .item-park {
        font-size: 0.75rem;
        color: var(--bs-secondary);
        margin: 0.2rem 0;
    }

    .item-meta {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .status-tag {
        font-size: 0.65rem;
        padding: 0.1rem 0.35rem;
        border-radius: 3px;
    }

    /* 加载动画 */
    .map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: rgba(255,255,255,0.95);
        padding: 1rem 1.5rem;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: var(--shadow);
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper p-0" style="margin: -1.5rem;">
    <!-- 顶部工具栏 -->
    <div class="map-toolbar">
        <div class="toolbar-filters">
            <select id="filterStatus" class="form-select form-select-sm">
                <option value="">全部状态</option>
                {% for status in rectify_statuses %}
                <option value="{{ status }}">{{ status }}</option>
                {% endfor %}
                <option value="已销号">已销号</option>
            </select>

            <select id="filterZone" class="form-select form-select-sm">
                <option value="">全部功能区</option>
                {% for zone in func_zones %}
                <option value="{{ zone }}">{{ zone }}</option>
                {% endfor %}
            </select>

            <select id="filterProblem" class="form-select form-select-sm">
                <option value="">全部问题</option>
                {% for type in problem_types %}
                <option value="{{ type }}">{{ type }}</option>
                {% endfor %}
            </select>

            <select id="filterEvent" class="form-select form-select-sm">
                <option value="">全部事件</option>
                {% for event in events %}
                <option value="{{ event.id }}">{{ event.event_name }}</option>
                {% endfor %}
            </select>

            <button id="btnRefresh" class="btn btn-sm btn-outline-secondary" title="刷新">
                <i class="bi bi-arrow-clockwise"></i>
            </button>

            <button id="btnExport" class="btn btn-sm btn-outline-success" title="导出">
                <i class="bi bi-download"></i>
            </button>
        </div>

        <div class="toolbar-stats">
            <div class="stat-mini total">
                <div class="num" id="statTotal">0</div>
                <div class="label">总数</div>
            </div>
            <div class="stat-mini pending">
                <div class="num" id="statPending">0</div>
                <div class="label">未整改</div>
            </div>
            <div class="stat-mini progress">
                <div class="num" id="statProgress">0</div>
                <div class="label">整改中</div>
            </div>
            <div class="stat-mini closed">
                <div class="num" id="statClosed">0</div>
                <div class="label">已销号</div>
            </div>
        </div>
    </div>

    <!-- 主体区域 -->
    <div class="map-body">
        <!-- 地图 -->
        <div class="map-section">
            <div id="map"></div>

            <div class="map-loading" id="mapLoading">
                <div class="spinner-border spinner-border-sm text-primary"></div>
                <span class="small">加载中...</span>
            </div>

            <div class="map-legend">
                <div class="legend-item"><span style="background: #dc3545;"></span>未整改</div>
                <div class="legend-item"><span style="background: #ffc107;"></span>整改中</div>
                <div class="legend-item"><span style="background: #17a2b8;"></span>已整改</div>
                <div class="legend-item"><span style="background: #28a745;"></span>已销号</div>
            </div>

            <div class="basemap-switch">
                <button class="active" data-layer="vec">矢量</button>
                <button data-layer="img">影像</button>
            </div>
        </div>

        <!-- 图斑列表 -->
        <div class="list-section">
            <div class="list-header">
                <h6>
                    <i class="bi bi-list text-primary"></i>
                    图斑列表
                    <span class="list-count" id="listCount">0</span>
                </h6>
            </div>
            <div class="list-content" id="tubanList">
                <div class="text-center py-4 text-muted small">
                    <i class="bi bi-geo-alt" style="font-size: 1.5rem;"></i>
                    <p class="mb-0 mt-1">选择条件后显示图斑</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
const TIANDITU_KEY = 'd602cd2008ab46fc508c4eef043b19c3';

let map;
let markersLayer;
let currentBasemap = 'vec';
let tubanMarkers = [];

function initMap() {
    map = L.map('map', {
        center: [24.78, 106.56],
        zoom: 10,
        zoomControl: true
    });

    addTiandituLayers('vec');

    markersLayer = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });
    map.addLayer(markersLayer);

    loadTubans();
    loadStats();
}

function addTiandituLayers(type) {
    map.eachLayer(function(layer) {
        if (layer._url && layer._url.includes('tianditu')) {
            map.removeLayer(layer);
        }
    });

    const layerType = type === 'img' ? 'img' : 'vec';
    const annoType = type === 'img' ? 'cia' : 'cva';

    L.tileLayer(`http://t{s}.tianditu.gov.cn/${layerType}_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=${layerType}&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=${TIANDITU_KEY}`, {
        subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
        maxZoom: 18
    }).addTo(map);

    L.tileLayer(`http://t{s}.tianditu.gov.cn/${annoType}_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=${annoType}&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=${TIANDITU_KEY}`, {
        subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
        maxZoom: 18
    }).addTo(map);

    currentBasemap = type;
}

function loadTubans() {
    const status = document.getElementById('filterStatus').value;
    const zone = document.getElementById('filterZone').value;
    const problem = document.getElementById('filterProblem').value;
    const event = document.getElementById('filterEvent').value;

    const params = new URLSearchParams();
    if (status) params.append('rectify_status', status);
    if (zone) params.append('func_zone', zone);
    if (problem) params.append('problem_type', problem);
    if (event) params.append('event_id', event);

    document.getElementById('mapLoading').style.display = 'flex';

    fetch(`/map/api/tubans?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            markersLayer.clearLayers();
            tubanMarkers = [];

            data.features.forEach(feature => {
                const coords = feature.geometry.coordinates;
                const props = feature.properties;

                const marker = L.circleMarker([coords[1], coords[0]], {
                    radius: 10,
                    fillColor: props.color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                marker.bindPopup(createPopupContent(props), {
                    maxWidth: 280,
                    className: 'tuban-popup'
                });

                marker.on('click', function() {
                    highlightListItem(props.id);
                });

                markersLayer.addLayer(marker);
                tubanMarkers.push({ id: props.id, marker: marker, props: props });
            });

            updateTubanList(data.features);
            document.getElementById('listCount').textContent = data.features.length;

            if (data.features.length > 0) {
                const bounds = markersLayer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [30, 30] });
                }
            }

            const urlParams = new URLSearchParams(window.location.search);
            const targetId = urlParams.get('id');
            if (targetId) {
                highlightAndZoomToTuban(parseInt(targetId));
            }

            document.getElementById('mapLoading').style.display = 'none';
        })
        .catch(error => {
            console.error('加载失败:', error);
            document.getElementById('mapLoading').style.display = 'none';
        });
}

function loadStats() {
    fetch('/map/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('statTotal').textContent = data.total;
            document.getElementById('statPending').textContent = data.pending;
            document.getElementById('statProgress').textContent = data.in_progress;
            document.getElementById('statClosed').textContent = data.closed;
        })
        .catch(error => console.error('加载统计失败:', error));
}

function updateTubanList(features) {
    const listContainer = document.getElementById('tubanList');

    if (features.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-4 text-muted small">
                <i class="bi bi-geo-alt" style="font-size: 1.5rem;"></i>
                <p class="mb-0 mt-1">暂无符合条件的数据</p>
            </div>
        `;
        return;
    }

    let html = '';
    features.forEach(feature => {
        const props = feature.properties;
        const statusClass = getStatusClass(props.rectify_status);

        html += `
            <div class="list-item" data-id="${props.id}" onclick="highlightAndZoomToTuban(${props.id})">
                <div class="item-code">${props.tuban_code}</div>
                <div class="item-park">${props.park_name || '-'}</div>
                <div class="item-meta">
                    <span class="badge ${statusTagClass(props.rectify_status)} status-tag">${props.rectify_status}</span>
                    ${props.problem_type ? `<span class="badge bg-secondary status-tag">${props.problem_type}</span>` : ''}
                    ${props.area ? `<span class="text-muted small">${props.area}㎡</span>` : ''}
                </div>
            </div>
        `;
    });

    listContainer.innerHTML = html;
}

function getStatusClass(status) {
    const map = {
        '未整改': 'bg-danger',
        '整改中': 'bg-warning text-dark',
        '已整改': 'bg-info',
        '已销号': 'bg-success'
    };
    return map[status] || 'bg-secondary';
}

function statusTagClass(status) {
    return getStatusClass(status);
}

function highlightAndZoomToTuban(id) {
    const item = tubanMarkers.find(m => m.id === id);
    if (!item) return;

    document.querySelectorAll('.list-item').forEach(el => el.classList.remove('active'));
    const listItem = document.querySelector(`.list-item[data-id="${id}"]`);
    if (listItem) {
        listItem.classList.add('active');
        listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    map.setView(item.marker.getLatLng(), 16);
    item.marker.openPopup();
}

function highlightListItem(id) {
    document.querySelectorAll('.list-item').forEach(el => el.classList.remove('active'));
    const listItem = document.querySelector(`.list-item[data-id="${id}"]`);
    if (listItem) {
        listItem.classList.add('active');
    }
}

function createPopupContent(props) {
    let badgeClass = 'bg-secondary';
    if (props.rectify_status === '未整改') badgeClass = 'bg-danger';
    else if (props.rectify_status === '整改中') badgeClass = 'bg-warning text-dark';
    else if (props.rectify_status === '已整改') badgeClass = 'bg-info';
    else if (props.is_closed === '是') badgeClass = 'bg-success';

    return `
        <div style="min-width: 180px;">
            <h6 style="margin: 0 0 6px; padding-bottom: 6px; border-bottom: 1px solid #eee; color: #2E8B57; font-size: 0.85rem;">
                <i class="bi bi-geo-alt-fill me-1"></i>${props.tuban_code}
            </h6>
            <div style="margin-bottom: 6px;">
                <span class="badge ${badgeClass}">${props.rectify_status}</span>
                ${props.is_closed === '是' ? '<span class="badge bg-success ms-1">已销号</span>' : ''}
            </div>
            <table style="width: 100%; font-size: 0.75rem;">
                <tr><td class="text-muted">公园</td><td>${props.park_name || '-'}</td></tr>
                <tr><td class="text-muted">功能区</td><td>${props.func_zone || '-'}</td></tr>
                <tr><td class="text-muted">问题</td><td>${props.problem_type || '-'}</td></tr>
                ${props.area ? `<tr><td class="text-muted">面积</td><td>${props.area} ㎡</td></tr>` : ''}
            </table>
            <a href="/tuban/detail/${props.id}" class="btn btn-sm btn-outline-primary w-100 mt-2" style="font-size: 0.7rem;">
                <i class="bi bi-eye me-1"></i>查看详情
            </a>
        </div>
    `;
}

document.addEventListener('DOMContentLoaded', function() {
    initMap();

    document.getElementById('filterStatus').addEventListener('change', loadTubans);
    document.getElementById('filterZone').addEventListener('change', loadTubans);
    document.getElementById('filterProblem').addEventListener('change', loadTubans);
    document.getElementById('filterEvent').addEventListener('change', loadTubans);

    document.getElementById('btnRefresh').addEventListener('click', function() {
        loadTubans();
        loadStats();
    });

    // 底图切换
    document.querySelectorAll('.basemap-switch button').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.basemap-switch button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            addTiandituLayers(this.dataset.layer);
        });
    });

    // 导出
    document.getElementById('btnExport').addEventListener('click', function() {
        const items = tubanMarkers.map(m => m.props);
        if (items.length === 0) {
            alert('当前没有数据可导出');
            return;
        }
        const headers = ['图斑编号', '地质公园', '功能区', '问题类型', '整改进展'];
        const csvContent = ['\ufeff' + headers.join(',')].concat(
            items.map(item => [item.tuban_code, item.park_name, item.func_zone, item.problem_type, item.rectify_status].join(','))
        ).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `图斑列表_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    });
});
</script>
{% endblock %}
