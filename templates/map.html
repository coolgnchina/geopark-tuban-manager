{% extends "base.html" %}

{% block title %}地图展示 - {{ config.APP_NAME }}{% endblock %}

{% block header %}图斑地图展示{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="ms-2">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
            <a href="{{ url_for('index') }}" class="text-decoration-none">
                <i class="bi bi-house me-1"></i>首页
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-map me-1"></i>地图展示
        </li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<style>
    /* 覆盖content-wrapper的限制 */
    #page-content-wrapper {
        max-width: 100% !important;
        width: calc(100vw - 260px) !important;
        margin-left: 260px !important;
    }

    /* 地图容器 */
    .map-wrap {
        height: calc(100vh - 64px - 48px);
        margin: -1.5rem;
        display: flex;
        flex-direction: column;
    }

    /* 工具栏 */
    .map-toolbar {
        background: white;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .toolbar-filters {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex: 1;
    }

    .toolbar-filters select,
    .toolbar-filters .btn {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
    }

    .toolbar-stats {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .stat-pill {
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        color: white;
        font-size: 0.75rem;
        text-align: center;
    }

    .stat-pill .num { font-weight: bold; font-size: 0.85rem; }
    .stat-pill .label { opacity: 0.85; font-size: 0.65rem; }
    .stat-pill.total { background: #2E8B57; }
    .stat-pill.pending { background: #dc3545; }
    .stat-pill.progress { background: #FFA500; }
    .stat-pill.closed { background: #17a2b8; }

    /* 内容区 */
    .map-content {
        flex: 1;
        display: flex;
        overflow: hidden;
    }

    /* 地图 */
    .map-main {
        flex: 1;
        position: relative;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    .map-legend {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: white;
        padding: 0.4rem 0.6rem;
        border-radius: 4px;
        font-size: 0.7rem;
        z-index: 1000;
        display: flex;
        gap: 0.75rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .legend-item span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    .basemap-switch {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        display: flex;
        background: white;
        border-radius: 4px;
        overflow: hidden;
    }

    .basemap-switch button {
        border: none;
        padding: 0.3rem 0.6rem;
        font-size: 0.7rem;
        background: transparent;
        cursor: pointer;
    }

    .basemap-switch button.active {
        background: #2E8B57;
        color: white;
    }

    /* 图斑列表 */
    .map-sidebar {
        width: 300px;
        min-width: 280px;
        max-width: 380px;
        background: white;
        border-left: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .sidebar-header h6 {
        margin: 0;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sidebar-count {
        background: #2E8B57;
        color: white;
        padding: 0.1rem 0.4rem;
        border-radius: 10px;
        font-size: 0.7rem;
    }

    .sidebar-list {
        flex: 1;
        overflow-y: auto;
    }

    .sidebar-item {
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background 0.15s;
    }

    .sidebar-item:hover {
        background: #f8f9fa;
    }

    .sidebar-item.active {
        background: #e7f1ff;
        border-left: 3px solid #0d6efd;
    }

    .item-title {
        font-weight: bold;
        color: #0d6efd;
        font-size: 0.85rem;
    }

    .item-park {
        font-size: 0.75rem;
        color: #6c757d;
        margin: 0.2rem 0;
    }

    .item-tags {
        display: flex;
        gap: 0.3rem;
        align-items: center;
    }

    .item-tag {
        font-size: 0.65rem;
        padding: 0.1rem 0.35rem;
        border-radius: 3px;
    }

    .loading-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: rgba(255,255,255,0.95);
        padding: 1rem 1.5rem;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }
</style>
{% endblock %}

{% block content %}
<div class="map-wrap">
    <!-- 工具栏 -->
    <div class="map-toolbar">
        <div class="toolbar-filters">
            <select id="filterStatus" class="form-select form-select-sm">
                <option value="">全部状态</option>
                {% for status in rectify_statuses %}
                <option value="{{ status }}">{{ status }}</option>
                {% endfor %}
                <option value="已销号">已销号</option>
            </select>

            <select id="filterZone" class="form-select form-select-sm">
                <option value="">全部功能区</option>
                {% for zone in func_zones %}
                <option value="{{ zone }}">{{ zone }}</option>
                {% endfor %}
            </select>

            <select id="filterProblem" class="form-select form-select-sm">
                <option value="">全部问题</option>
                {% for type in problem_types %}
                <option value="{{ type }}">{{ type }}</option>
                {% endfor %}
            </select>

            <select id="filterEvent" class="form-select form-select-sm">
                <option value="">全部事件</option>
                {% for event in events %}
                <option value="{{ event.id }}">{{ event.event_name }}</option>
                {% endfor %}
            </select>

            <button id="btnRefresh" class="btn btn-sm btn-outline-secondary" title="刷新">
                <i class="bi bi-arrow-clockwise"></i>
            </button>

            <button id="btnExport" class="btn btn-sm btn-outline-success" title="导出">
                <i class="bi bi-download"></i>
            </button>
        </div>

        <div class="toolbar-stats">
            <div class="stat-pill total">
                <div class="num" id="statTotal">0</div>
                <div class="label">总数</div>
            </div>
            <div class="stat-pill pending">
                <div class="num" id="statPending">0</div>
                <div class="label">未整改</div>
            </div>
            <div class="stat-pill progress">
                <div class="num" id="statProgress">0</div>
                <div class="label">整改中</div>
            </div>
            <div class="stat-pill closed">
                <div class="num" id="statClosed">0</div>
                <div class="label">已销号</div>
            </div>
        </div>
    </div>

    <!-- 内容区 -->
    <div class="map-content">
        <!-- 地图 -->
        <div class="map-main">
            <div id="map"></div>

            <div class="loading-overlay" id="mapLoading">
                <div class="spinner-border spinner-border-sm text-primary"></div>
                <span class="small">加载中...</span>
            </div>

            <div class="map-legend">
                <div class="legend-item"><span style="background: #dc3545;"></span>未整改</div>
                <div class="legend-item"><span style="background: #ffc107;"></span>整改中</div>
                <div class="legend-item"><span style="background: #17a2b8;"></span>已整改</div>
                <div class="legend-item"><span style="background: #28a745;"></span>已销号</div>
            </div>

            <div class="basemap-switch">
                <button class="active" data-layer="vec">矢量</button>
                <button data-layer="img">影像</button>
            </div>
        </div>

        <!-- 图斑列表 -->
        <div class="map-sidebar">
            <div class="sidebar-header">
                <h6>
                    <i class="bi bi-list text-primary"></i>
                    图斑列表
                    <span class="sidebar-count" id="listCount">0</span>
                </h6>
            </div>
            <div class="sidebar-list" id="tubanList">
                <div class="text-center py-4 text-muted small">
                    <i class="bi bi-geo-alt" style="font-size: 1.5rem;"></i>
                    <p class="mb-0 mt-1">选择条件后显示图斑</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
const TIANDITU_KEY = 'd602cd2008ab46fc508c4eef043b19c3';

let map;
let markersLayer;
let tubanMarkers = [];

function initMap() {
    map = L.map('map', {
        center: [24.78, 106.56],
        zoom: 10
    });

    addTiandituLayers('vec');

    markersLayer = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });
    map.addLayer(markersLayer);

    loadTubans();
    loadStats();
}

function addTiandituLayers(type) {
    map.eachLayer(function(layer) {
        if (layer._url && layer._url.includes('tianditu')) {
            map.removeLayer(layer);
        }
    });

    const layerType = type === 'img' ? 'img' : 'vec';
    const annoType = type === 'img' ? 'cia' : 'cva';

    L.tileLayer(`http://t{s}.tianditu.gov.cn/${layerType}_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=${layerType}&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=${TIANDITU_KEY}`, {
        subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
        maxZoom: 18
    }).addTo(map);

    L.tileLayer(`http://t{s}.tianditu.gov.cn/${annoType}_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=${annoType}&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=${TIANDITU_KEY}`, {
        subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
        maxZoom: 18
    }).addTo(map);
}

function loadTubans() {
    const status = document.getElementById('filterStatus').value;
    const zone = document.getElementById('filterZone').value;
    const problem = document.getElementById('filterProblem').value;
    const event = document.getElementById('filterEvent').value;

    const params = new URLSearchParams();
    if (status) params.append('rectify_status', status);
    if (zone) params.append('func_zone', zone);
    if (problem) params.append('problem_type', problem);
    if (event) params.append('event_id', event);

    document.getElementById('mapLoading').style.display = 'flex';

    fetch(`/map/api/tubans?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            markersLayer.clearLayers();
            tubanMarkers = [];

            data.features.forEach(feature => {
                const coords = feature.geometry.coordinates;
                const props = feature.properties;

                const marker = L.circleMarker([coords[1], coords[0]], {
                    radius: 10,
                    fillColor: props.color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                marker.bindPopup(createPopupContent(props), { maxWidth: 280 });
                marker.on('click', function() { highlightListItem(props.id); });

                markersLayer.addLayer(marker);
                tubanMarkers.push({ id: props.id, marker: marker, props: props });
            });

            updateTubanList(data.features);
            document.getElementById('listCount').textContent = data.features.length;

            if (data.features.length > 0) {
                const bounds = markersLayer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [30, 30] });
                }
            }

            const targetId = new URLSearchParams(window.location.search).get('id');
            if (targetId) {
                highlightAndZoomToTuban(parseInt(targetId));
            }

            document.getElementById('mapLoading').style.display = 'none';
        })
        .catch(error => {
            console.error('加载失败:', error);
            document.getElementById('mapLoading').style.display = 'none';
        });
}

function loadStats() {
    fetch('/map/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('statTotal').textContent = data.total;
            document.getElementById('statPending').textContent = data.pending;
            document.getElementById('statProgress').textContent = data.in_progress;
            document.getElementById('statClosed').textContent = data.closed;
        });
}

function updateTubanList(features) {
    const listContainer = document.getElementById('tubanList');

    if (features.length === 0) {
        listContainer.innerHTML = '<div class="text-center py-4 text-muted small"><i class="bi bi-geo-alt" style="font-size: 1.5rem;"></i><p class="mb-0 mt-1">暂无符合条件的数据</p></div>';
        return;
    }

    let html = '';
    features.forEach(feature => {
        const props = feature.properties;
        const statusColor = {'未整改': 'danger', '整改中': 'warning text-dark', '已整改': 'info', '已销号': 'success'}[props.rectify_status] || 'secondary';

        html += `<div class="sidebar-item" data-id="${props.id}" onclick="highlightAndZoomToTuban(${props.id})">
            <div class="item-title">${props.tuban_code}</div>
            <div class="item-park">${props.park_name || '-'}</div>
            <div class="item-tags">
                <span class="badge bg-${statusColor} item-tag">${props.rectify_status}</span>
                ${props.problem_type ? `<span class="badge bg-secondary item-tag">${props.problem_type}</span>` : ''}
                ${props.area ? `<span class="text-muted small">${props.area}㎡</span>` : ''}
            </div>
        </div>`;
    });

    listContainer.innerHTML = html;
}

function highlightAndZoomToTuban(id) {
    const item = tubanMarkers.find(m => m.id === id);
    if (!item) return;

    document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
    const listItem = document.querySelector(`.sidebar-item[data-id="${id}"]`);
    if (listItem) {
        listItem.classList.add('active');
        listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    map.setView(item.marker.getLatLng(), 16);
    item.marker.openPopup();
}

function highlightListItem(id) {
    document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
    const listItem = document.querySelector(`.sidebar-item[data-id="${id}"]`);
    if (listItem) listItem.classList.add('active');
}

function createPopupContent(props) {
    const statusColor = {'未整改': 'danger', '整改中': 'warning text-dark', '已整改': 'info', '已销号': 'success'}[props.rectify_status] || 'secondary';

    return `<div style="min-width: 180px;">
        <h6 style="margin: 0 0 6px; padding-bottom: 6px; border-bottom: 1px solid #eee; color: #2E8B57; font-size: 0.85rem;">
            <i class="bi bi-geo-alt-fill me-1"></i>${props.tuban_code}
        </h6>
        <div style="margin-bottom: 6px;">
            <span class="badge bg-${statusColor}">${props.rectify_status}</span>
            ${props.is_closed === '是' ? '<span class="badge bg-success ms-1">已销号</span>' : ''}
        </div>
        <table style="width: 100%; font-size: 0.75rem;">
            <tr><td class="text-muted">公园</td><td>${props.park_name || '-'}</td></tr>
            <tr><td class="text-muted">功能区</td><td>${props.func_zone || '-'}</td></tr>
            <tr><td class="text-muted">问题</td><td>${props.problem_type || '-'}</td></tr>
            ${props.area ? `<tr><td class="text-muted">面积</td><td>${props.area} ㎡</td></tr>` : ''}
        </table>
        <a href="/tuban/detail/${props.id}" class="btn btn-sm btn-outline-primary w-100 mt-2" style="font-size: 0.7rem;">
            <i class="bi bi-eye me-1"></i>查看详情
        </a>
    </div>`;
}

document.addEventListener('DOMContentLoaded', function() {
    initMap();

    document.getElementById('filterStatus').addEventListener('change', loadTubans);
    document.getElementById('filterZone').addEventListener('change', loadTubans);
    document.getElementById('filterProblem').addEventListener('change', loadTubans);
    document.getElementById('filterEvent').addEventListener('change', loadTubans);

    document.getElementById('btnRefresh').addEventListener('click', function() { loadTubans(); loadStats(); });

    document.querySelectorAll('.basemap-switch button').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.basemap-switch button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            addTiandituLayers(this.dataset.layer);
        });
    });

    document.getElementById('btnExport').addEventListener('click', function() {
        const items = tubanMarkers.map(m => m.props);
        if (items.length === 0) { alert('当前没有数据可导出'); return; }

        const csv = ['\ufeff图斑编号,地质公园,功能区,问题类型,整改进展']
            .concat(items.map(i => `${i.tuban_code},${i.park_name},${i.func_zone},${i.problem_type},${i.rectify_status}`))
            .join('\n');

        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        a.download = `图斑列表_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
    });
});
</script>
{% endblock %}
