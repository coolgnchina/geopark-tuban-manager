{% extends 'base.html' %}

{% block title %}地图展示 - {{ config.APP_NAME }}{% endblock %}

{% block header %}图斑地图展示{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<style>
    /* 地图容器样式 */
    #map-container {
        height: calc(100vh - 140px);
        min-height: 500px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    #map {
        height: 100%;
        width: 100%;
    }
    
    /* 筛选控件样式 */
    .map-filter-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    /* 统计卡片样式 */
    .stat-card {
        padding: 12px 16px;
        border-radius: 8px;
        color: white;
        text-align: center;
    }
    
    .stat-card.total { background: linear-gradient(135deg, #667eea, #764ba2); }
    .stat-card.pending { background: linear-gradient(135deg, #f093fb, #f5576c); }
    .stat-card.progress { background: linear-gradient(135deg, #4facfe, #00f2fe); }
    .stat-card.closed { background: linear-gradient(135deg, #43e97b, #38f9d7); }
    
    .stat-card h4 { font-size: 1.5rem; margin: 0; font-weight: bold; }
    .stat-card small { opacity: 0.9; }
    
    /* 图例样式 */
    .map-legend {
        background: white;
        padding: 10px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .legend-item:last-child { margin-bottom: 0; }
    
    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    /* 底图切换控件 */
    .basemap-control {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    
    .basemap-control .btn {
        border: none;
        background: transparent;
    }
    
    .basemap-control .btn.active {
        background: #2E8B57;
        color: white;
    }
    
    /* 弹窗样式 */
    .leaflet-popup-content-wrapper {
        border-radius: 8px;
    }
    
    .tuban-popup h6 {
        color: #2E8B57;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin-bottom: 8px;
    }
    
    .tuban-popup .badge {
        font-size: 0.75rem;
    }
    
    /* 加载动画 */
    .map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: rgba(255,255,255,0.9);
        padding: 20px 40px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- 筛选和统计区域 -->
    <div class="row g-3 mb-3">
        <!-- 筛选控件 -->
        <div class="col-lg-8">
            <div class="map-filter-card p-3">
                <div class="row g-2 align-items-center">
                    <div class="col-auto">
                        <label class="form-label mb-0 fw-bold">
                            <i class="bi bi-funnel me-1"></i>筛选
                        </label>
                    </div>
                    <div class="col-md-3">
                        <select id="filterStatus" class="form-select form-select-sm">
                            <option value="">全部状态</option>
                            {% for status in rectify_statuses %}
                            <option value="{{ status }}">{{ status }}</option>
                            {% endfor %}
                            <option value="已销号">已销号</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="filterZone" class="form-select form-select-sm">
                            <option value="">全部功能区</option>
                            {% for zone in func_zones %}
                            <option value="{{ zone }}">{{ zone }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="filterProblem" class="form-select form-select-sm">
                            <option value="">全部问题类型</option>
                            {% for type in problem_types %}
                            <option value="{{ type }}">{{ type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <button id="btnRefresh" class="btn btn-sm btn-primary">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 统计卡片 -->
        <div class="col-lg-4">
            <div class="row g-2">
                <div class="col-3">
                    <div class="stat-card total">
                        <h4 id="statTotal">0</h4>
                        <small>总数</small>
                    </div>
                </div>
                <div class="col-3">
                    <div class="stat-card pending">
                        <h4 id="statPending">0</h4>
                        <small>未整改</small>
                    </div>
                </div>
                <div class="col-3">
                    <div class="stat-card progress">
                        <h4 id="statProgress">0</h4>
                        <small>整改中</small>
                    </div>
                </div>
                <div class="col-3">
                    <div class="stat-card closed">
                        <h4 id="statClosed">0</h4>
                        <small>已销号</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 地图区域 -->
    <div class="position-relative" id="map-container">
        <div id="map"></div>
        
        <!-- 加载提示 -->
        <div class="map-loading" id="mapLoading">
            <div class="spinner-border text-primary me-2" role="status"></div>
            <span>加载中...</span>
        </div>
        
        <!-- 底图切换 -->
        <div class="basemap-control btn-group btn-group-sm" id="basemapControl">
            <button type="button" class="btn active" data-layer="vec">
                <i class="bi bi-map"></i> 矢量
            </button>
            <button type="button" class="btn" data-layer="img">
                <i class="bi bi-image"></i> 影像
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
// 天地图Key
const TIANDITU_KEY = 'd602cd2008ab46fc508c4eef043b19c3';

// 地图实例
let map;
let markersLayer;
let currentBasemap = 'vec';

// 初始化地图
function initMap() {
    // 创建地图实例，中心点设为广西乐业-凤山地区
    map = L.map('map', {
        center: [24.78, 106.56],  // 乐业县中心坐标
        zoom: 10,
        zoomControl: true
    });
    
    // 添加天地图图层
    addTiandituLayers('vec');
    
    // 创建标记图层组
    markersLayer = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });
    map.addLayer(markersLayer);
    
    // 添加图例
    addLegend();
    
    // 加载数据
    loadTubans();
    loadStats();
}

// 添加天地图图层
function addTiandituLayers(type) {
    // 清除现有图层
    map.eachLayer(function(layer) {
        if (layer._url && layer._url.includes('tianditu')) {
            map.removeLayer(layer);
        }
    });
    
    // 底图类型
    const layerType = type === 'img' ? 'img' : 'vec';
    const annoType = type === 'img' ? 'cia' : 'cva';
    
    // 底图
    L.tileLayer(`http://t{s}.tianditu.gov.cn/${layerType}_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=${layerType}&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=${TIANDITU_KEY}`, {
        subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
        maxZoom: 18
    }).addTo(map);
    
    // 注记层
    L.tileLayer(`http://t{s}.tianditu.gov.cn/${annoType}_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=${annoType}&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=${TIANDITU_KEY}`, {
        subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
        maxZoom: 18
    }).addTo(map);
    
    currentBasemap = type;
}

// 添加图例
function addLegend() {
    const legend = L.control({ position: 'bottomleft' });
    legend.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'map-legend');
        div.innerHTML = `
            <div class="legend-item"><span class="legend-dot" style="background: #dc3545;"></span>未整改</div>
            <div class="legend-item"><span class="legend-dot" style="background: #ffc107;"></span>整改中</div>
            <div class="legend-item"><span class="legend-dot" style="background: #17a2b8;"></span>已整改</div>
            <div class="legend-item"><span class="legend-dot" style="background: #28a745;"></span>已销号</div>
        `;
        return div;
    };
    legend.addTo(map);
}

// 加载图斑数据
function loadTubans() {
    const status = document.getElementById('filterStatus').value;
    const zone = document.getElementById('filterZone').value;
    const problem = document.getElementById('filterProblem').value;
    
    // 构建查询参数
    const params = new URLSearchParams();
    if (status) params.append('rectify_status', status);
    if (zone) params.append('func_zone', zone);
    if (problem) params.append('problem_type', problem);
    
    // 显示加载提示
    document.getElementById('mapLoading').style.display = 'block';
    
    fetch(`/map/api/tubans?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            // 清除现有标记
            markersLayer.clearLayers();
            
            // 添加新标记
            data.features.forEach(feature => {
                const coords = feature.geometry.coordinates;
                const props = feature.properties;
                
                // 创建圆形标记
                const marker = L.circleMarker([coords[1], coords[0]], {
                    radius: 8,
                    fillColor: props.color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // 绑定弹窗
                marker.bindPopup(createPopupContent(props), {
                    maxWidth: 300,
                    className: 'tuban-popup'
                });
                
                markersLayer.addLayer(marker);
            });
            
            // 更新统计
            document.getElementById('statTotal').textContent = data.total;
            
            // 如果有数据，自动缩放到数据范围
            if (data.features.length > 0) {
                const bounds = markersLayer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
            
            // 隐藏加载提示
            document.getElementById('mapLoading').style.display = 'none';
        })
        .catch(error => {
            console.error('加载图斑数据失败:', error);
            document.getElementById('mapLoading').style.display = 'none';
        });
}

// 加载统计数据
function loadStats() {
    fetch('/map/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('statTotal').textContent = data.total;
            document.getElementById('statPending').textContent = data.pending;
            document.getElementById('statProgress').textContent = data.in_progress;
            document.getElementById('statClosed').textContent = data.closed;
        })
        .catch(error => console.error('加载统计数据失败:', error));
}

// 创建弹窗内容
function createPopupContent(props) {
    // 根据状态设置徽章颜色
    let badgeClass = 'bg-secondary';
    if (props.rectify_status === '未整改') badgeClass = 'bg-danger';
    else if (props.rectify_status === '整改中') badgeClass = 'bg-warning text-dark';
    else if (props.rectify_status === '已整改') badgeClass = 'bg-info';
    else if (props.is_closed === '是' || props.rectify_status === '已销号') badgeClass = 'bg-success';
    
    return `
        <div class="tuban-popup">
            <h6 class="mb-2">
                <i class="bi bi-geo-alt-fill me-1"></i>${props.tuban_code}
            </h6>
            <div class="mb-2">
                <span class="badge ${badgeClass}">${props.rectify_status}</span>
                ${props.is_closed === '是' ? '<span class="badge bg-success ms-1">已销号</span>' : ''}
            </div>
            <table class="table table-sm table-borderless mb-2" style="font-size: 0.85rem;">
                <tr><td class="text-muted" style="width: 70px;">地质公园</td><td>${props.park_name || '-'}</td></tr>
                <tr><td class="text-muted">功能区</td><td>${props.func_zone || '-'}</td></tr>
                <tr><td class="text-muted">问题类型</td><td>${props.problem_type || '-'}</td></tr>
                ${props.area ? `<tr><td class="text-muted">面积</td><td>${props.area} ㎡</td></tr>` : ''}
                ${props.rectify_deadline ? `<tr><td class="text-muted">整改期限</td><td>${props.rectify_deadline}</td></tr>` : ''}
            </table>
            <a href="/tuban/detail/${props.id}" class="btn btn-sm btn-outline-primary w-100">
                <i class="bi bi-eye me-1"></i>查看详情
            </a>
        </div>
    `;
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    
    // 筛选事件
    document.getElementById('filterStatus').addEventListener('change', loadTubans);
    document.getElementById('filterZone').addEventListener('change', loadTubans);
    document.getElementById('filterProblem').addEventListener('change', loadTubans);
    document.getElementById('btnRefresh').addEventListener('click', function() {
        loadTubans();
        loadStats();
    });
    
    // 底图切换
    document.querySelectorAll('#basemapControl .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#basemapControl .btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            addTiandituLayers(this.dataset.layer);
        });
    });
});
</script>
{% endblock %}
