{% extends "base.html" %}

{% block title %}地图展示 - {{ config.APP_NAME }}{% endblock %}

{% block header %}图斑地图展示{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="ms-2">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
            <a href="{{ url_for('index') }}" class="text-decoration-none">
                <i class="bi bi-house me-1"></i>首页
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-map me-1"></i>地图展示
        </li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<style>
    /* 地图容器 */
    #map-container {
        height: calc(100vh - 180px);
        min-height: 400px;
    }

    #map {
        height: 100%;
        width: 100%;
    }

    /* 侧边栏 */
    .tuban-sidebar {
        max-height: calc(100vh - 180px);
        overflow-y: auto;
    }

    /* 图斑列表 */
    .tuban-list {
        max-height: calc(100vh - 180px);
        overflow-y: auto;
    }

    .tuban-item {
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid transparent;
    }

    .tuban-item:hover {
        background-color: var(--bs-light-bg-subtle);
        border-left-color: var(--bs-primary);
    }

    .tuban-item.active {
        background-color: var(--bs-light-bg-subtle);
        border-left-color: var(--bs-primary);
    }

    /* 统计卡片 - 紧凑横向 */
    .stat-compact {
        padding: 0.5rem 0.75rem;
        border-radius: var(--border-radius-sm);
        color: white;
        text-align: center;
        min-width: 80px;
    }

    .stat-compact.total { background: linear-gradient(135deg, #2E8B57, #228B22); }
    .stat-compact.pending { background: linear-gradient(135deg, #dc3545, #c82333); }
    .stat-compact.progress { background: linear-gradient(135deg, #FFA500, #e69500); }
    .stat-compact.closed { background: linear-gradient(135deg, #20c997, #17a2b8); }

    .stat-compact h4 { font-size: 1.1rem; margin: 0; font-weight: bold; }
    .stat-compact small { opacity: 0.85; font-size: 0.7rem; }

    /* 图例 */
    .map-legend {
        background: white;
        padding: 0.5rem;
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow-sm);
    }

    .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 6px;
        display: inline-block;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
        font-size: 0.75rem;
    }

    /* 弹窗样式 */
    .leaflet-popup-content-wrapper {
        border-radius: 8px;
    }

    .tuban-popup h6 {
        color: #2E8B57;
        border-bottom: 1px solid #eee;
        padding-bottom: 6px;
        margin-bottom: 6px;
        font-size: 0.95rem;
    }

    .tuban-popup .badge {
        font-size: 0.7rem;
    }

    /* 加载动画 */
    .map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: rgba(255,255,255,0.9);
        padding: 20px 40px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- 筛选和统计区域（横向紧凑布局） -->
    <div class="row g-2 mb-2 align-items-center">
        <!-- 筛选控件 -->
        <div class="col-auto">
            <div class="d-flex gap-2 align-items-center">
                <select id="filterStatus" class="form-select form-select-sm" style="width: 110px;">
                    <option value="">全部状态</option>
                    {% for status in rectify_statuses %}
                    <option value="{{ status }}">{{ status }}</option>
                    {% endfor %}
                    <option value="已销号">已销号</option>
                </select>

                <select id="filterZone" class="form-select form-select-sm" style="width: 130px;">
                    <option value="">全部功能区</option>
                    {% for zone in func_zones %}
                    <option value="{{ zone }}">{{ zone }}</option>
                    {% endfor %}
                </select>

                <select id="filterProblem" class="form-select form-select-sm" style="width: 130px;">
                    <option value="">全部问题类型</option>
                    {% for type in problem_types %}
                    <option value="{{ type }}">{{ type }}</option>
                    {% endfor %}
                </select>

                <select id="filterEvent" class="form-select form-select-sm" style="width: 180px;">
                    <option value="">全部事件</option>
                    {% for event in events %}
                    <option value="{{ event.id }}">{{ event.event_name }}</option>
                    {% endfor %}
                </select>

                <button id="btnRefresh" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>

                <button id="btnExport" class="btn btn-sm btn-outline-success">
                    <i class="bi bi-download me-1"></i>导出列表
                </button>
            </div>
        </div>

        <!-- 统计卡片（横向紧凑） -->
        <div class="col-auto ms-auto">
            <div class="d-flex gap-2">
                <div class="stat-compact total">
                    <h4 id="statTotal">0</h4>
                    <small>总数</small>
                </div>
                <div class="stat-compact pending">
                    <h4 id="statPending">0</h4>
                    <small>未整改</small>
                </div>
                <div class="stat-compact progress">
                    <h4 id="statProgress">0</h4>
                    <small>整改中</small>
                </div>
                <div class="stat-compact closed">
                    <h4 id="statClosed">0</h4>
                    <small>已销号</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 主区域：地图 + 图斑列表 -->
    <div class="row g-3">
        <!-- 地图区域 -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-map me-2"></i>地图展示
                        <span class="badge bg-secondary ms-2" id="mapCount">0个</span>
                    </h6>
                    <!-- 底图切换 -->
                    <div class="btn-group btn-group-sm" id="basemapControl">
                        <button type="button" class="btn active" data-layer="vec">
                            <i class="bi bi-map"></i> 矢量
                        </button>
                        <button type="button" class="btn" data-layer="img">
                            <i class="bi bi-image"></i> 影像
                        </button>
                    </div>
                </div>
                <div class="card-body p-0 position-relative" id="map-container">
                    <div id="map"></div>

                    <!-- 加载提示 -->
                    <div class="map-loading" id="mapLoading">
                        <div class="spinner-border text-primary me-2" role="status"></div>
                        <span>加载中...</span>
                    </div>

                    <!-- 图例 -->
                    <div class="map-legend position-absolute" style="top: 10px; left: 10px; z-index: 1000;">
                        <div class="legend-item"><span class="legend-dot" style="background: #dc3545;"></span>未整改</div>
                        <div class="legend-item"><span class="legend-dot" style="background: #ffc107;"></span>整改中</div>
                        <div class="legend-item"><span class="legend-dot" style="background: #17a2b8;"></span>已整改</div>
                        <div class="legend-item"><span class="legend-dot" style="background: #28a745;"></span>已销号</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图斑列表侧边栏 -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-list-ul me-2"></i>图斑列表
                        <span class="badge bg-info ms-2" id="listCount">0</span>
                    </h6>
                </div>
                <div class="card-body p-2 tuban-list">
                    <div id="tubanList" class="list-group list-group-flush">
                        <!-- 图斑列表项将通过JS动态生成 -->
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                            <p class="mb-0 mt-2 small">暂无数据</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
// 天地图Key
const TIANDITU_KEY = 'd602cd2008ab46fc508c4eef043b19c3';

// 地图实例
let map;
let markersLayer;
let currentBasemap = 'vec';
let tubanMarkers = [];

// 初始化地图
function initMap() {
    // 创建地图实例，中心点设为广西乐业-凤山地区
    map = L.map('map', {
        center: [24.78, 106.56],
        zoom: 10,
        zoomControl: true
    });

    // 添加天地图图层
    addTiandituLayers('vec');

    // 创建标记图层组
    markersLayer = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });
    map.addLayer(markersLayer);

    // 加载数据
    loadTubans();
    loadStats();
}

// 添加天地图图层
function addTiandituLayers(type) {
    // 清除现有图层
    map.eachLayer(function(layer) {
        if (layer._url && layer._url.includes('tianditu')) {
            map.removeLayer(layer);
        }
    });

    // 底图类型
    const layerType = type === 'img' ? 'img' : 'vec';
    const annoType = type === 'img' ? 'cia' : 'cva';

    // 底图
    L.tileLayer(`http://t{s}.tianditu.gov.cn/${layerType}_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=${layerType}&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=${TIANDITU_KEY}`, {
        subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
        maxZoom: 18
    }).addTo(map);

    // 注记层
    L.tileLayer(`http://t{s}.tianditu.gov.cn/${annoType}_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=${annoType}&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=${TIANDITU_KEY}`, {
        subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
        maxZoom: 18
    }).addTo(map);

    currentBasemap = type;
}

// 加载图斑数据
function loadTubans() {
    const status = document.getElementById('filterStatus').value;
    const zone = document.getElementById('filterZone').value;
    const problem = document.getElementById('filterProblem').value;
    const event = document.getElementById('filterEvent').value;

    // 构建查询参数
    const params = new URLSearchParams();
    if (status) params.append('rectify_status', status);
    if (zone) params.append('func_zone', zone);
    if (problem) params.append('problem_type', problem);
    if (event) params.append('event_id', event);

    // 显示加载提示
    document.getElementById('mapLoading').style.display = 'block';

    fetch(`/map/api/tubans?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            // 清除现有标记
            markersLayer.clearLayers();
            tubanMarkers = [];

            // 添加新标记
            data.features.forEach(feature => {
                const coords = feature.geometry.coordinates;
                const props = feature.properties;

                // 创建圆形标记
                const marker = L.circleMarker([coords[1], coords[0]], {
                    radius: 10,
                    fillColor: props.color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                // 绑定弹窗
                marker.bindPopup(createPopupContent(props), {
                    maxWidth: 280,
                    className: 'tuban-popup'
                });

                // 点击标记高亮列表项
                marker.on('click', function() {
                    highlightListItem(props.id);
                    // 打开列表详情
                    showListItemDetail(props.id);
                });

                markersLayer.addLayer(marker);

                // 保存标记引用
                tubanMarkers.push({ id: props.id, marker: marker, props: props });
            });

            // 更新列表
            updateTubanList(data.features);

            // 更新地图计数
            document.getElementById('mapCount').textContent = data.features.length + '个';
            document.getElementById('listCount').textContent = data.features.length;

            // 自动缩放到数据范围
            if (data.features.length > 0) {
                const bounds = markersLayer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [30, 30] });
                }
            }

            // 检查URL是否有指定图斑ID
            const urlParams = new URLSearchParams(window.location.search);
            const targetId = urlParams.get('id');
            if (targetId) {
                highlightAndZoomToTuban(parseInt(targetId));
            }

            // 隐藏加载提示
            document.getElementById('mapLoading').style.display = 'none';
        })
        .catch(error => {
            console.error('加载图斑数据失败:', error);
            document.getElementById('mapLoading').style.display = 'none';
        });
}

// 加载统计数据
function loadStats() {
    fetch('/map/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('statTotal').textContent = data.total;
            document.getElementById('statPending').textContent = data.pending;
            document.getElementById('statProgress').textContent = data.in_progress;
            document.getElementById('statClosed').textContent = data.closed;
        })
        .catch(error => console.error('加载统计数据失败:', error));
}

// 更新图斑列表
function updateTubanList(features) {
    const listContainer = document.getElementById('tubanList');

    if (features.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                <p class="mb-0 mt-2 small">暂无数据</p>
            </div>
        `;
        return;
    }

    let html = '';
    features.forEach(feature => {
        const props = feature.properties;
        const statusColor = getStatusColorClass(props.rectify_status);

        html += `
            <div class="list-group-item list-group-item-action tuban-item" data-id="${props.id}" onclick="highlightAndZoomToTuban(${props.id})">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="fw-bold text-primary mb-1" style="font-size: 0.9rem;">
                            ${props.tuban_code}
                            ${props.is_superior_focus === '是' ? '<span class="badge bg-danger ms-1" style="font-size: 0.6rem;">重点</span>' : ''}
                        </div>
                        <div class="small text-muted mb-1">${props.park_name || '-'}</div>
                        <div class="small">
                            <span class="badge ${statusColor}" style="font-size: 0.7rem;">${props.rectify_status}</span>
                            ${props.problem_type ? `<span class="badge bg-secondary ms-1" style="font-size: 0.7rem;">${props.problem_type}</span>` : ''}
                        </div>
                    </div>
                    ${props.area ? `<div class="text-end text-muted small">${props.area}㎡</div>` : ''}
                </div>
            </div>
        `;
    });

    listContainer.innerHTML = html;
}

// 获取状态颜色类名
function getStatusColorClass(status) {
    const colorMap = {
        '未整改': 'bg-danger',
        '整改中': 'bg-warning text-dark',
        '已整改': 'bg-info',
        '已销号': 'bg-success'
    };
    return colorMap[status] || 'bg-secondary';
}

// 高亮并缩放到指定图斑
function highlightAndZoomToTuban(id) {
    const item = tubanMarkers.find(m => m.id === id);
    if (!item) return;

    // 移除其他高亮
    document.querySelectorAll('.tuban-item').forEach(el => el.classList.remove('active'));

    // 高亮列表项
    const listItem = document.querySelector(`.tuban-item[data-id="${id}"]`);
    if (listItem) {
        listItem.classList.add('active');
        listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // 缩放到标记
    map.setView(item.marker.getLatLng(), 16);
    item.marker.openPopup();
}

// 高亮列表项
function highlightListItem(id) {
    document.querySelectorAll('.tuban-item').forEach(el => el.classList.remove('active'));
    const listItem = document.querySelector(`.tuban-item[data-id="${id}"]`);
    if (listItem) {
        listItem.classList.add('active');
    }
}

// 显示列表项详情（可扩展为弹窗）
function showListItemDetail(id) {
    const item = tubanMarkers.find(m => m.id === id);
    if (!item) return;

    // 这里可以添加侧边栏详情展开功能
    console.log('Show detail for:', item.props);
}

// 导出当前列表
document.getElementById('btnExport')?.addEventListener('click', function() {
    const items = tubanMarkers.map(m => m.props);
    if (items.length === 0) {
        alert('当前没有数据可导出');
        return;
    }

    // 简单的CSV导出
    const headers = ['图斑编号', '地质公园', '功能区', '问题类型', '整改进展'];
    const csvContent = [
        headers.join(','),
        ...items.map(item => [
            item.tuban_code,
            item.park_name,
            item.func_zone,
            item.problem_type,
            item.rectify_status
        ].join(','))
    ].join('\n');

    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `图斑列表_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
});

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    initMap();

    // 筛选事件
    document.getElementById('filterStatus').addEventListener('change', loadTubans);
    document.getElementById('filterZone').addEventListener('change', loadTubans);
    document.getElementById('filterProblem').addEventListener('change', loadTubans);
    document.getElementById('filterEvent').addEventListener('change', loadTubans);
    document.getElementById('btnRefresh').addEventListener('click', function() {
        loadTubans();
        loadStats();
    });

    // 底图切换
    document.querySelectorAll('#basemapControl .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#basemapControl .btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            addTiandituLayers(this.dataset.layer);
        });
    });
});
</script>
{% endblock %}
